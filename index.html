<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบขายหน้าร้าน (POS)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --light-bg: #f8f9fa;
            --white-color: #ffffff;
            --dark-text: #343a40;
            --border-color: #dee2e6;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            margin: 0;
        }

        .body-content {
            padding: 1.5rem;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            max-width: 1400px;
            margin: auto;
        }

        .card {
            background-color: var(--white-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        h2, h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            margin-top: 0;
            font-size: 1.5rem;
        }
        
        h3 {
            font-size: 1.25rem;
        }
        
        h4 {
            margin: 0;
            color: var(--secondary-color);
            font-size: 1.1rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            text-align: center;
        }
        .summary-item {
            background-color: #f1f3f5;
            padding: 1rem;
            border-radius: 8px;
        }
        .summary-item .label {
            font-size: 1em;
            color: var(--secondary-color);
        }
        .summary-item .value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .pos-layout {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 1.5rem;
        }
        
        .search-column, .cart-column {
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            font-size: 0.9em;
            color: var(--secondary-color);
            display: block;
            margin-bottom: 0.5rem;
        }

        input, select {
            width: 100%; 
            padding: 0.75rem;
            font-size: 1em;
            box-sizing: border-box; 
            border: 1px solid var(--border-color); 
            border-radius: 4px;
            font-family: 'Sarabun', sans-serif;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        #barcode-input:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        #search-results {
            margin-top: 1rem;
            overflow-y: hidden;
            border: 1px solid transparent;
            border-radius: 4px;
            height: 1px;
            min-height: 1px;
            transition: all 0.2s ease-in-out;
            flex-grow: 0;
        }

        #search-results.has-results {
            border-color: var(--border-color);
            min-height: 150px;
            height: auto;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .search-item {
            padding: 0.75rem; cursor: pointer; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between;
            align-items: center;
        }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover, .search-item.selected {
            background-color: var(--primary-color); color: var(--white-color);
        }
        .search-item.selected .price, .search-item.selected .sub-text { color: var(--white-color); }
        .search-item .sub-text {
            font-size: 0.8em;
            color: var(--secondary-color);
            font-weight: normal;
        }

        .cart-header-row {
            display: grid;
            grid-template-columns: 30px 1fr 120px 100px 110px 40px;
            gap: 0.75rem;
            padding: 0 0.75rem 0.5rem 0.75rem;
            font-weight: bold;
            color: var(--secondary-color);
            border-bottom: 2px solid var(--border-color);
            align-items: center;
        }
        
        .cart-header-row .col-name { text-align: left; }
        .cart-header-row .col-center { text-align: center; }
        .cart-header-row .col-right { text-align: right; }
        
        #cart-items {
            list-style-type: none; padding: 0; 
            overflow-y: auto; min-height: 300px;
            margin-top: 0.5rem;
            flex-grow: 1;
        }

        #cart-items li {
            background-color: #f1f3f5; 
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            display: grid;
            grid-template-columns: 30px 1fr 120px 100px 110px 40px;
            align-items: center; 
            gap: 0.75rem;
            font-size: 14px;
        }
        
        .item-input {
            text-align: right;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px;
            font-size: 14px;
            background-color: var(--white-color);
            width: 100%;
            box-sizing: border-box;
            -moz-appearance: textfield;
        }
        .item-input::-webkit-outer-spin-button,
        .item-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .col-qty {
            display: flex;
            align-items: center;
            gap: 5px;
        }
         .col-qty .item-input {
            width: 45px;
            text-align: center;
        }

        .delete-item-btn {
            background: transparent;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .delete-item-btn:hover {
            transform: scale(1.2);
        }

        .delete-item-btn svg {
            width: 18px;
            height: 18px;
        }

        .totals-section {
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            font-size: 1.2em;
            margin-bottom: 0.5rem;
            align-items: center;
        }
        .total-row label, .total-row span {
            font-weight: bold;
        }
        #discount-input {
            width: 120px;
            font-size: 1em;
            text-align: right;
        }
        #cart-total {
            color: var(--success-color);
            font-size: 1.5em;
        }

        .button-group { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .button-group-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }

        button {
            background-color: var(--primary-color); color: white; border: none;
            padding: 0.75rem 1rem; border-radius: 4px; cursor: pointer;
            font-size: 1em; font-family: 'Sarabun', sans-serif;
            transition: background-color 0.3s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        button:active { transform: scale(0.98); }
        button.finish-sale { background-color: var(--success-color); }
        button.clear-cart { background-color: var(--danger-color); }
        .delete-history-btn {
            background-color: var(--danger-color); padding: 0.25rem 0.75rem; font-size: 0.9em;
        }
        .edit-history-btn {
            background-color: var(--info-color); padding: 0.25rem 0.75rem;
            font-size: 0.9em; margin-right: 5px;
        }
        
        #history-table-wrapper {
            max-height: 600px; overflow-y: auto; border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        #history-table { width: 100%; border-collapse: collapse; }
        #history-table th, #history-table td { 
            border-bottom: 1px solid var(--border-color); padding: 0.75rem;
            text-align: left; vertical-align: middle;
        }
        #history-table th { background-color: #e9ecef; position: sticky; top: 0; }
        #history-table tr:nth-child(even) { background-color: var(--light-bg); }

        #history-table tr.exported-row {
            background-color: #f1f8e9;
            opacity: 0.8;
        }
        #history-table tr.exported-row:hover {
            opacity: 1;
        }
        #history-table tr.exported-row td {
            color: #555;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: var(--white-color); padding: 2rem; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px;
            display: flex; flex-direction: column;
        }
        .modal-content h3 { margin-top: 0; }
        .modal-content p {
            white-space: pre-wrap;
            text-align: left;
            margin-bottom: 1.5rem;
        }
        
        .payment-modal-body {
            width: 100%;
            margin-top: 1.5rem;
        }
        .payment-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .payment-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .payment-label {
            font-size: 1.5em;
            color: var(--secondary-color);
        }
        .payment-amount {
            font-weight: bold;
        }
        #payment-total-final {
            font-size: 2.5em;
            color: var(--primary-color);
        }
        #cash-received-input {
            font-size: 2em;
            text-align: right;
            width: 50%;
        }
        #payment-change {
            font-size: 3em;
            color: var(--success-color);
        }

        /* Tabs System */
        .cart-tabs-container {
            display: flex;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
        }
        #cart-tabs {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 2px; /* For scrollbar space */
        }
        .tab-button {
            padding: 0.75rem 1rem;
            cursor: pointer;
            background-color: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            font-size: 1em;
            color: var(--secondary-color);
            position: relative;
            flex-shrink: 0;
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: bold;
        }
        .close-tab-btn {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.2em;
            padding: 0 0 0 0.5rem;
            line-height: 1;
            opacity: 0.5;
            border-radius: 50%;
        }
        .close-tab-btn:hover {
            opacity: 1;
            background-color: rgba(0,0,0,0.1);
        }

        /* --- Product Management Styles --- */
        #product-mgmt-modal .modal-content {
            max-width: 90vw;
            width: 1200px;
            height: 90vh;
        }
        .modal-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        #product-list-container {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        .product-list-row {
            display: grid;
            grid-template-columns: 1fr 100px 150px 150px;
            gap: 1rem;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }
        .product-list-row:last-child {
            border-bottom: none;
        }
        .product-list-row:nth-child(even) {
            background-color: var(--light-bg);
        }
        
        /* --- Product Editor Modal (Improved) --- */
        #product-editor-modal .modal-content {
            max-width: 1200px;
            width: 90vw;
            height: 85vh;
            padding: 0; /* Remove padding to use full space */
        }
        #product-editor-modal h3 {
             padding: 1.5rem 1.5rem 0.5rem 1.5rem;
             margin-bottom: 1rem;
        }
        #product-editor-form {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }
        .form-content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 1.5rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .form-column-left, .form-column-right {
            display: flex;
            flex-direction: column;
        }
        #product-editor-form .button-group {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            margin-top: 0; /* Remove margin-top as it's a sticky footer now */
            background-color: var(--white-color);
        }

        .pricing-unit-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #fdfdfd;
        }
        .pricing-unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .pricing-unit-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        #pricing-units-container {
            flex-grow: 1;
        }
        .price-tiers-container {
            margin-top: 1rem;
        }
        .price-tier-header {
            display: grid;
            grid-template-columns: 1fr 1fr 40px;
            gap: 0.5rem;
            font-size: 0.8em;
            color: var(--secondary-color);
            padding: 0 4px;
        }
        .price-tier-row {
            display: grid;
            grid-template-columns: 1fr 1fr 40px;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .add-tier-btn {
            padding: 0.5rem;
            font-size: 0.9em;
            background-color: var(--secondary-color);
        }
        #add-pricing-unit-btn {
             background-color: var(--info-color);
             margin-top: 1rem;
        }

        /* Responsive */
        @media (max-width: 992px) {
            #product-editor-modal .form-content-area {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            .body-content { padding: 0.5rem; }
            .card { padding: 1rem; }
            .pos-layout { grid-template-columns: 1fr; }
            h2, h3 { font-size: 1.25rem; }
            h3 { font-size: 1.1rem; }
            .summary-grid { gap: 0.5rem; }
            .summary-item .value { font-size: 1.5em; }
            .payment-label { font-size: 1.2em; }
            #payment-total-final { font-size: 2em; }
            #cash-received-input { font-size: 1.5em; }
            #payment-change { font-size: 2.2em; }
            #cart-items li, .cart-header-row {
                gap: 0.5rem;
                grid-template-columns: 24px 1fr 80px 70px 80px 24px;
            }
            .col-qty .item-input { width: 40px; }
            .delete-item-btn, .close-tab-btn { width: 24px; height: 24px; line-height: 24px; font-size: 1.2em; }
            .filter-section { flex-direction: column; align-items: stretch !important; }
            .filter-section input, .filter-section button { width: 100%; box-sizing: border-box; margin-bottom: 0.5rem; }
            .pricing-unit-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="body-content">
        <main class="main-container">
            <section class="card">
                <div class="pos-layout">
                    <div class="search-column">
                        <h2><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>ค้นหาสินค้า</h2>
                        <div class="form-group">
                            <label for="barcode-input">F2:บิลใหม่ | F5:ค้นหา | F8:ล้าง | F9:ชำระเงิน | F11:ส่วนลด | Del:ปิดบิล</label>
                            <input type="text" id="barcode-input" 
                                   inputmode="latin" 
                                   placeholder="[ENG] ค้นหา... (เช่น: 3*1234.)" 
                                   data-base-placeholder="ค้นหา... (เช่น: 3*1234.)"
                                   autofocus>
                        </div>
                        <div id="search-results"></div>

                        <div id="sales-summary-section" style="margin-top: 1.5rem; display: none;">
                            <h3 id="summary-title">สรุปยอดขาย</h3>
                            <div class="summary-grid">
                                <div class="summary-item"><div class="label">ยอดขายรวม</div><div class="value" id="summary-total-sales">0.00</div></div>
                                <div class="summary-item"><div class="label">ส่วนลดรวม</div><div class="value" id="summary-total-discount" style="color: var(--warning-color);">0.00</div></div>
                                <div class="summary-item"><div class="label">ยอดขายสุทธิ</div><div class="value" id="summary-net-sales" style="color: var(--success-color);">0.00</div></div>
                                <div class="summary-item"><div class="label">กำไร</div><div class="value" id="summary-profit" style="color: #00aaff;">0.00</div></div>
                                <div class="summary-item"><div class="label">จำนวนบิล</div><div class="value" id="summary-bill-count">0</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="cart-column">
                        <div class="cart-tabs-container"><div id="cart-tabs"></div></div>
                        <div id="edit-status" style="display: none; padding: 10px; background-color: #fff3cd; color: #856404; border-radius: 4px; margin-bottom: 1rem; margin-top:1rem;"></div>
                        <div class="cart-header-row">
                            <span class="col-seq">#</span><span class="col-name">สินค้า</span><span class="col-qty col-center">จำนวน</span><span class="col-price col-right">ราคา/หน่วย</span><span class="col-total col-right">รวม</span><span class="col-delete col-center">ลบ</span>
                        </div>
                        <ul id="cart-items"></ul>
                        <div class="totals-section">
                            <div class="total-row"><label>ยอดรวม:</label><span id="cart-subtotal">0.00</span></div>
                            <div class="total-row"><label for="discount-input">ส่วนลด (บาท):</label><input type="number" id="discount-input" placeholder="0.00"></div>
                            <div class="total-row" style="font-size: 1.5em; color: var(--success-color);"><label>ยอดสุทธิ:</label><span id="cart-total">0.00</span></div>
                        </div>
                        <div class="button-group-2">
                            <button class="finish-sale">ชำระเงิน (F9)</button>
                            <button class="clear-cart">ล้างตะกร้า (F8)</button>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="card">
                <h2>การตั้งค่าและจัดการ</h2>
                <div class="button-group">
                    <button id="manage-products-btn" style="background-color: var(--info-color);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                        จัดการสินค้า
                    </button>
                    <button id="import-from-sheet-btn" style="background-color: var(--success-color);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                        นำเข้า/อัปเดตจาก Google Sheet
                    </button>
                </div>
                <div style="margin-top: 1rem; display: flex; align-items: center;">
                    <input type="checkbox" id="auto-import-toggle" style="width: auto; margin-right: 0.5rem;">
                    <label for="auto-import-toggle">นำเข้าข้อมูลอัตโนมัติเมื่อมีการเปลี่ยนแปลง (ตรวจสอบทุก 5 นาที)</label>
                </div>
            </section>

            <section class="card">
                <h2>ประวัติการขาย</h2>
                <div class="filter-section" style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap;">
                    <label for="start-date">ตั้งแต่:</label><input type="date" id="start-date" style="padding: 5px; border-radius: 4px; border: 1px solid var(--border-color);"><input type="time" id="start-time" style="padding: 5px; border-radius: 4px; border: 1px solid var(--border-color);">
                    <label for="end-date">ถึง:</label><input type="date" id="end-date" style="padding: 5px; border-radius: 4px; border: 1px solid var(--border-color);"><input type="time" id="end-time" style="padding: 5px; border-radius: 4px; border: 1px solid var(--border-color);">
                    <button id="filter-history-btn" style="flex-grow: 0;">ค้นหา</button><button id="today-history-btn" style="flex-grow: 0; background-color: var(--info-color);">วันนี้</button>
                </div>
                <div class="button-group" style="justify-content: flex-start; margin-bottom: 1rem;">
                    <button id="export-excel-btn" style="flex-grow: 0;">Export to Excel</button><button id="clear-all-history-btn" class="clear-cart" style="flex-grow: 0; margin-left: auto;">ล้างประวัติทั้งหมด</button>
                </div>
                <div id="history-table-wrapper"><table id="history-table"><thead><tr><th>วันที่/เวลา</th><th>รหัสการขาย</th><th>รายการสินค้า (จำนวน)</th><th>ส่วนลด</th><th>ยอดรวมสุทธิ</th><th>การกระทำ</th></tr></thead><tbody id="history-body"></tbody></table></div>
            </section>
        </main>
    
        <div id="payment-modal" class="modal-overlay"><div class="modal-content"><h3>ชำระเงิน</h3><div class="payment-modal-body"><div class="payment-row"><span class="payment-label">ยอดสุทธิที่ต้องชำระ</span><span class="payment-amount" id="payment-total-final">0.00</span></div><div class="payment-row"><label for="cash-received-input" class="payment-label">รับเงินมา</label><input type="number" id="cash-received-input" step="any" placeholder="0.00"></div><div class="payment-row"><span class="payment-label">เงินทอน</span><span class="payment-amount" id="payment-change">0.00</span></div></div><div class="button-group" style="margin-top: 1.5rem; justify-content: center;"><button id="confirm-sale-btn" class="finish-sale">ยืนยันการขาย (Enter)</button><button class="clear-cart" id="cancel-payment-btn">ยกเลิก (ESC)</button></div></div></div>
    
        <div id="delete-confirm-modal" class="modal-overlay"><div class="modal-content"><h3>ยืนยันการลบ</h3><p id="delete-confirm-text"></p><div class="button-group" style="justify-content: center;"><button id="confirm-delete-btn" class="clear-cart">ยืนยันการลบ</button><button id="cancel-delete-btn">ยกเลิก</button></div></div></div>
    
        <div id="clear-options-modal" class="modal-overlay"><div class="modal-content"><h3>เลือกวิธีการล้างประวัติ</h3><p>คุณต้องการล้างประวัติการขายแบบใด?</p><div class="button-group" style="flex-direction: column; gap: 1rem;"><button id="clear-local-btn" class="clear-cart" style="background-color: var(--info-color);">ล้างเฉพาะหน้าเว็บนี้</button><button id="clear-db-btn" class="clear-cart">ล้างจากฐานข้อมูล (ถาวร)</button><button id="cancel-clear-btn" style="background-color: var(--secondary-color);">ยกเลิก</button></div></div></div>
    
        <div id="info-modal" class="modal-overlay"><div class="modal-content"><h3 id="info-modal-title" style="color: var(--primary-color);"></h3><p id="info-modal-text"></p><div class="button-group" style="justify-content: center;"><button id="info-modal-ok-btn">ตกลง (Enter/ESC)</button></div></div></div>
    
        <div id="product-mgmt-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-toolbar">
                    <h2>จัดการสินค้า</h2>
                    <button id="add-new-product-btn" class="finish-sale">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        เพิ่มสินค้าใหม่
                    </button>
                </div>
                <div id="product-list-container">
                    </div>
                <div class="button-group" style="justify-content: flex-end;">
                    <button id="close-product-mgmt-btn" style="background-color: var(--secondary-color);">ปิด</button>
                </div>
            </div>
        </div>

        <div id="product-editor-modal" class="modal-overlay">
            <div class="modal-content">
                <form id="product-editor-form">
                    <h3 id="product-editor-title">เพิ่มสินค้าใหม่</h3>
                    
                    <div class="form-content-area">
                        <div class="form-column-left">
                            <h4 style="border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem;">ข้อมูลสินค้าหลัก</h4>
                            <div class="form-group">
                                <label for="product-code">รหัสสินค้า (ห้ามซ้ำ)</label>
                                <input type="text" id="product-code" required>
                            </div>
                            <div class="form-group">
                                <label for="product-name">ชื่อสินค้า</label>
                                <input type="text" id="product-name" required>
                            </div>
                            <div class="form-group">
                                <label for="product-category">หมวดหมู่ (ไม่บังคับ)</label>
                                <input type="text" id="product-category">
                            </div>
                            <div class="form-group">
                                <label for="product-base-unit">หน่วยเล็กที่สุด (สำหรับนับสต็อก)</label>
                                <input type="text" id="product-base-unit" placeholder="เช่น ชิ้น, ขวด, กรัม" required>
                            </div>
                            <div class="form-group">
                                <label for="product-stock">จำนวนสต็อก (ตามหน่วยเล็กที่สุด)</label>
                                <input type="number" id="product-stock" value="0" required>
                            </div>
                        </div>

                        <div class="form-column-right">
                            <h4 style="border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem;">หน่วยและราคาขาย</h4>
                            <div id="pricing-units-container">
                                </div>
                             <button type="button" id="add-pricing-unit-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                เพิ่มหน่วยขาย
                            </button>
                        </div>
                    </div>

                    <div class="button-group" style="justify-content: flex-end;">
                        <button type="button" id="cancel-product-editor-btn" style="background-color: var(--secondary-color);">ยกเลิก</button>
                        <button type="submit" id="save-product-btn" class="finish-sale">บันทึกสินค้า</button>
                    </div>
                </form>
            </div>
        </div>
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, writeBatch, getDocs, query, where, setDoc, updateDoc, collectionGroup, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOx9RPxrG-vO59QHjkhJtGmyDRhdoVFPY",
            authDomain: "pos-6-23035.firebaseapp.com",
            projectId: "pos-6-23035",
            storageBucket: "pos-6-23035.firebasestorage.app",
            messagingSenderId: "1025982856125",
            appId: "1:1025982856125:web:8c6cdf5712e44abe0f30d4"
        };

        try {
            const appId = firebaseConfig.projectId;
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            setLogLevel('error');
            await signInAnonymously(auth);
            console.log("Signed in anonymously.");
            window.firebaseServices = { db, auth, appId, api: { collection, onSnapshot, addDoc, doc, deleteDoc, writeBatch, getDocs, query, where, setDoc, updateDoc, collectionGroup } };
        } catch (error) {
            console.error("Firebase Initialization Failed:", error);
            window.firebaseFailed = true;
            window.firebaseError = error.message;
        } finally {
            window.firebaseReady = true;
        }
    </script>

    <script>
    const POS_APP = {
        config: {
            googleSheetUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTT3t_8Hx7WcD8uUi2IGt1zDbOMB3MSK57dYnfqrrut3do_Gw2hzYSG9IBIEg8fg7uTEL2sVq-IfVJR/pub?gid=0&single=true&output=csv',
            thaiToEngMap: { 'ๅ': '1', '/': '2', '-': '3', 'ภ': '4', 'ถ': '5', 'ุ': '6', 'ึ': '7', 'ค': '8', 'ต': '9', 'จ': '0', 'ข': '-', 'ช': '=', 'ๆ': 'q', 'ไ': 'w', 'ำ': 'e', 'พ': 'r', 'ะ': 't', 'ั': 'y', 'ี': 'u', 'ร': 'i', 'น': 'o', 'ย': 'p', 'บ': '[', 'ล': ']', 'ฟ': 'a', 'ห': 's', 'ก': 'd', 'ด': 'f', 'เ': 'g', '้': 'h', '่': 'j', 'า': 'k', 'ส': 'l', 'ว': ';', 'ง': "'", 'ผ': 'z', 'ป': 'x', 'แ': 'c', 'อ': 'v', 'ิ': 'b', 'ท': 'n', 'ม': 'm', 'ใ': ',', 'ฝ': '.', 'ซ': '/' }
        },
        state: {
            salesHistory: [],
            currentSearchResults: [],
            selectedSearchIndex: -1,
            unsubscribeSalesHistory: null,
            isSaving: false,
            activeModalCloseHandler: null,
            tabs: new Map(),
            activeTabId: null,
            isRestrictedMode: true,
            keyboardLayout: 'ENG',
            basePlaceholder: 'ค้นหา...',
            productsFromFirestore: [],
            searchableProductUnits: [],
            unsubscribeProducts: null,
            currentEditingProductId: null,
            lastSheetHash: null,
            autoImportInterval: null,
        },

        init() {
            const firebaseCheckInterval = setInterval(() => {
                if (window.firebaseReady) {
                    clearInterval(firebaseCheckInterval);
                    if (window.firebaseFailed) {
                        this.showInfoModal("ข้อผิดพลาดร้ายแรง", `ไม่สามารถเชื่อมต่อฐานข้อมูลได้: ${window.firebaseError}`, true);
                        return;
                    }
                    this.start();
                }
            }, 100);
        },
        
        start() {
            console.log("Initializing main application logic...");
            const barcodeInput = document.getElementById('barcode-input');
            if (barcodeInput) this.state.basePlaceholder = barcodeInput.getAttribute('data-base-placeholder');
            this.updatePlaceholderHint();
            this.clearDataOnStart();
            this.filterHistoryForToday();
            if (this.state.tabs.size === 0) this.addNewSaleTab();
            this.listenForProducts();
            this.setupEventListeners();
            this.toggleUIVisibility();  
            document.getElementById('barcode-input').focus();
        },
        
        clearDataOnStart() {
            this.state.salesHistory = [];
            this.state.tabs = new Map();
            this.state.activeTabId = null;
            if (this.state.unsubscribeSalesHistory) this.state.unsubscribeSalesHistory();
            this.updateHistoryDisplay();
            this.calculateSummaryForDisplayedHistory();
            this.renderTabs();
            const cartItemsEl = document.getElementById('cart-items');
            if (cartItemsEl) cartItemsEl.innerHTML = '';
            this.updateCartDisplay();
        },

        setupEventListeners() {
            document.getElementById('import-from-sheet-btn').addEventListener('click', () => this.importFromGoogleSheet(false));
            const barcodeInput = document.getElementById('barcode-input');
            barcodeInput.addEventListener('input', this.handleInstantSearch.bind(this));
            barcodeInput.addEventListener('keydown', this.handleSearchKeyDown.bind(this));
            barcodeInput.addEventListener('keydown', this.detectKeyboardLayout.bind(this));
            document.getElementById('discount-input').addEventListener('input', this.updateCartOnInput.bind(this));
            document.getElementById('discount-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); this.showPaymentModal(); }});
            document.querySelector('.finish-sale').addEventListener('click', this.showPaymentModal.bind(this));
            document.querySelector('.clear-cart').addEventListener('click', this.showClearCartConfirmModal.bind(this));
            document.getElementById('filter-history-btn').addEventListener('click', this.filterHistoryByDateTime.bind(this));
            document.getElementById('today-history-btn').addEventListener('click', this.filterHistoryForToday.bind(this));
            document.getElementById('export-excel-btn').addEventListener('click', this.exportToExcel.bind(this));
            document.getElementById('clear-all-history-btn').addEventListener('click', this.showClearOptionsModal.bind(this));
            document.getElementById('cash-received-input').addEventListener('input', this.calculateChange.bind(this));
            document.getElementById('cash-received-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); this.calculateChange(); document.getElementById('confirm-sale-btn').focus(); }});
            document.getElementById('confirm-sale-btn').addEventListener('click', this.confirmSale.bind(this));
            document.getElementById('cancel-payment-btn').addEventListener('click', this.hidePaymentModal.bind(this));
            document.getElementById('cancel-delete-btn').addEventListener('click', this.hideDeleteConfirmModal.bind(this));
            document.getElementById('clear-local-btn').addEventListener('click', this.clearHistoryLocally.bind(this));
            document.getElementById('clear-db-btn').addEventListener('click', this.executeClearAllHistory.bind(this));
            document.getElementById('cancel-clear-btn').addEventListener('click', this.hideClearOptionsModal.bind(this));
            document.getElementById('info-modal-ok-btn').addEventListener('click', this.hideInfoModal.bind(this));
            document.addEventListener('keydown', this.handleGlobalKeyDown.bind(this));
            document.getElementById('manage-products-btn').addEventListener('click', this.showProductMgmtModal.bind(this));
            document.getElementById('close-product-mgmt-btn').addEventListener('click', this.hideProductMgmtModal.bind(this));
            document.getElementById('add-new-product-btn').addEventListener('click', () => this.showProductEditorModal());
            document.getElementById('product-editor-form').addEventListener('submit', this.handleSaveProduct.bind(this));
            document.getElementById('cancel-product-editor-btn').addEventListener('click', this.hideProductEditorModal.bind(this));
            document.getElementById('add-pricing-unit-btn').addEventListener('click', this.handleAddPricingUnit.bind(this));
            document.getElementById('product-list-container').addEventListener('click', this.handleProductListActions.bind(this));
            document.getElementById('product-editor-modal').addEventListener('click', this.handlePricingUnitActions.bind(this));
            
            // Event listener for the new auto-import toggle
            document.getElementById('auto-import-toggle').addEventListener('change', (e) => {
                if (e.target.checked) {
                    this.startAutoImportPolling();
                } else {
                    this.stopAutoImportPolling();
                }
            });
        },
        
        // --- ฟังก์ชันสำหรับ Auto-Import ---
        async _hashText(text) {
            // ฟังก์ชัน hash อย่างง่าย ไม่ต้องใช้ library
            if (!text) return 0;
            let hash = 0;
            for (let i = 0; i < text.length; i++) {
                const char = text.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0; // Convert to 32bit integer
            }
            return hash;
        },

        startAutoImportPolling() {
            // หยุดการทำงานเดิมถ้ามี
            if (this.state.autoImportInterval) {
                clearInterval(this.state.autoImportInterval);
            }

            // ตั้งค่าให้ตรวจสอบทุกๆ 5 นาที (300000 ms)
            const intervalMinutes = 5;
            this.state.autoImportInterval = setInterval(async () => {
                console.log('Auto-Import: Checking for Google Sheet updates...');
                
                try {
                    const response = await fetch(this.config.googleSheetUrl);
                    if (!response.ok) return; // ถ้า fetch ไม่ได้ก็ข้ามไป
                    
                    const csvText = await response.text();
                    const currentHash = await this._hashText(csvText);

                    if (this.state.lastSheetHash && this.state.lastSheetHash !== currentHash) {
                        console.log('Auto-Import: Detected changes. Importing...');
                        this.showInfoModal('อัปเดตอัตโนมัติ', 'ตรวจพบการเปลี่ยนแปลงใน Google Sheet กำลังนำเข้าข้อมูล...');
                        this.importFromGoogleSheet(true); // เรียกใช้ import แบบอัตโนมัติ (ไม่มี popup ยืนยัน)
                    } else if (!this.state.lastSheetHash) {
                         console.log('Auto-Import: Initial hash set.');
                    }

                    this.state.lastSheetHash = currentHash;
                } catch (error) {
                    console.error('Auto-Import Error:', error);
                }
            }, intervalMinutes * 60 * 1000);
            
            // เรียกตรวจสอบครั้งแรกทันทีที่เปิดใช้งาน เพื่อตั้งค่า hash เริ่มต้น
            (async () => {
                try {
                    const response = await fetch(this.config.googleSheetUrl);
                    if(response.ok) this.state.lastSheetHash = await this._hashText(await response.text());
                    console.log('Auto-Import: Polling started. Initial hash captured.');
                } catch (e) {}
            })();
        },

        stopAutoImportPolling() {
            if (this.state.autoImportInterval) {
                clearInterval(this.state.autoImportInterval);
                this.state.autoImportInterval = null;
                console.log('Auto-Import: Polling stopped.');
            }
        },

        importFromGoogleSheet(isAutomatic = false) {
            if (!isAutomatic && !confirm('คุณต้องการนำเข้าข้อมูลจาก Google Sheet หรือไม่?\n\nการกระทำนี้จะใช้ "รหัสสินค้า" ในการค้นหา:\n- "อัปเดต" สินค้าที่มีรหัสตรงกัน\n- "เพิ่ม" สินค้าใหม่ที่ยังไม่มีในระบบ\n(ข้อมูลราคาขายที่ซับซ้อนของเดิมจะไม่ถูกลบ)')) {
                return;
            }

            this.showInfoModal("กำลังนำเข้า...", "กำลังดาวน์โหลดข้อมูลจาก Google Sheet กรุณารอสักครู่...");

            Papa.parse(this.config.googleSheetUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: async (results) => {
                    const sheetData = results.data;
                    if (!sheetData || sheetData.length === 0) {
                        this.showInfoModal("ผิดพลาด", "ไม่พบข้อมูลใน Google Sheet หรือไฟล์อาจมีปัญหา", true);
                        return;
                    }

                    try {
                        const { db, api } = window.firebaseServices;
                        const productsCollectionRef = this.getProductsCollectionRef();
                        
                        this.showInfoModal("กำลังประมวลผล...", "กำลังตรวจสอบข้อมูลสินค้าเดิมในระบบ...");

                        // 1. ดึงข้อมูลสินค้าทั้งหมดจาก Firestore มาสร้าง Map โดยใช้ "productCode" เป็น Key
                        const existingProducts = new Map();
                        const snapshot = await api.getDocs(productsCollectionRef);
                        snapshot.forEach(doc => {
                            const product = doc.data();
                            // ตรวจสอบว่ามีฟิลด์ productCode หรือไม่
                            if (product.productCode) {
                                existingProducts.set(product.productCode, { id: doc.id, data: product });
                            }
                        });

                        this.showInfoModal("กำลังประมวลผล...", `พบข้อมูล ${sheetData.length} รายการใน Sheet, กำลังเปรียบเทียบและอัปเดต...`);
                        
                        const batch = api.writeBatch(db);
                        const now = new Date().toISOString();
                        let updatedCount = 0;
                        let addedCount = 0;

                        // 2. วนลูปข้อมูลจาก Sheet เพื่อตัดสินใจว่าจะ อัปเดต หรือ เพิ่มใหม่
                        for (const row of sheetData) {
                            // เปลี่ยนมาใช้ "รหัสสินค้า" จาก Sheet
                            const productCode = row['รหัสสินค้า'] ? row['รหัสสินค้า'].trim() : '';
                            if (!productCode) continue; // ข้ามแถวที่ไม่มีรหัสสินค้า

                            const barcode = row['บาร์โค้ด'] ? row['บาร์โค้ด'].trim() : '';
                            const existingProductInfo = existingProducts.get(productCode);

                            if (existingProductInfo) {
                                // ---- UPDATE LOGIC ----
                                // 1. เจอสินค้าที่มีรหัสตรงกัน
                                const docRef = api.doc(db, productsCollectionRef.path, existingProductInfo.id);
                                const productData = existingProductInfo.data;
                                let unitFound = false;

                                // 2. ค้นหา pricingUnit ที่มี barcode ตรงกันเพื่ออัปเดต
                                productData.pricingUnits = productData.pricingUnits.map(unit => {
                                    if (unit.barcode === barcode) {
                                        unitFound = true;
                                        // อัปเดตข้อมูลของ unit นี้
                                        unit.cost = parseFloat(row['ต้นทุน']) || unit.cost || 0;
                                        unit.defaultPrice = parseFloat(row['ราคา']) || unit.defaultPrice || 0;
                                        
                                        // อัปเดต Price Tier แรกสุด
                                        const baseTier = (unit.priceTiers || []).find(t => t.quantity === 1);
                                        if (baseTier) {
                                            baseTier.price = unit.defaultPrice;
                                        } else {
                                            if (!unit.priceTiers) unit.priceTiers = [];
                                            unit.priceTiers.push({ quantity: 1, price: unit.defaultPrice });
                                            unit.priceTiers.sort((a, b) => b.quantity - a.quantity);
                                        }
                                    }
                                    return unit;
                                });

                                // 3. ถ้าไม่เจอ unit ที่มี barcode ตรงกัน แต่รหัสสินค้าตรง -> เพิ่มเป็น unit ใหม่ของสินค้านั้น
                                if (!unitFound && barcode) {
                                    const defaultPrice = parseFloat(row['ราคา']) || 0;
                                    productData.pricingUnits.push({
                                        unitName: row['หน่วย'] ? row['หน่วย'].trim() : 'หน่วย',
                                        barcode: barcode,
                                        cost: parseFloat(row['ต้นทุน']) || 0,
                                        conversionFactor: 1, // ควรตั้งค่าให้ถูกต้องภายหลัง
                                        defaultPrice: defaultPrice,
                                        priceTiers: [{ quantity: 1, price: defaultPrice }]
                                    });
                                }

                                batch.update(docRef, {
                                    stockInBaseUnits: parseInt(row['คงเหลือ'], 10) || productData.stockInBaseUnits,
                                    pricingUnits: productData.pricingUnits, // อัปเดต array ทั้งหมด
                                    updatedAt: now
                                });
                                updatedCount++;
                            } else {
                                // ---- ADD LOGIC ----
                                // ไม่เจอสินค้า: สร้างเอกสารใหม่พร้อมใส่ "productCode"
                                const productName = row['ชื่อการค้า'] ? row['ชื่อการค้า'].trim() : '';
                                if (!productName) continue;

                                const newDocRef = api.doc(productsCollectionRef);
                                const unitName = row['หน่วย'] ? row['หน่วย'].trim() : 'หน่วย';
                                const defaultPrice = parseFloat(row['ราคา']) || 0;

                                const newProductData = {
                                    productCode: productCode, // <--- เพิ่มฟิลด์นี้เข้าไป
                                    productName: productName,
                                    category: row['หมวดหมู่'] ? row['หมวดหมู่'].trim() : '',
                                    baseUnit: unitName,
                                    stockInBaseUnits: parseInt(row['คงเหลือ'], 10) || 0,
                                    pricingUnits: [{
                                        unitName: unitName,
                                        barcode: barcode,
                                        cost: parseFloat(row['ต้นทุน']) || 0,
                                        conversionFactor: 1,
                                        defaultPrice: defaultPrice,
                                        priceTiers: [{ quantity: 1, price: defaultPrice }]
                                    }],
                                    createdAt: now,
                                    updatedAt: now
                                };
                                batch.set(newDocRef, newProductData);
                                addedCount++;
                            }
                        }

                        // 4. Commit การเปลี่ยนแปลงทั้งหมด
                        await batch.commit();
                        this.showInfoModal("สำเร็จ", `นำเข้าข้อมูลเรียบร้อยแล้ว\nอัปเดต ${updatedCount} รายการ, เพิ่มใหม่ ${addedCount} รายการ`);

                    } catch (error) {
                        console.error("Error importing data to Firestore:", error);
                        this.showInfoModal("ผิดพลาด", `เกิดข้อผิดพลาดระหว่างนำเข้าข้อมูล: ${error.message}`, true);
                    }
                },
                error: (error) => {
                    console.error("Error parsing Google Sheet:", error);
                    this.showInfoModal("ผิดพลาด", `ไม่สามารถโหลดข้อมูลจาก Google Sheet ได้: ${error.message}`, true);
                }
            });
        },

        getSalesHistoryCollectionRef() { const { appId, db, api } = window.firebaseServices; return api.collection(db, `artifacts/${appId}/public/data/salesHistory`); },
        getProductsCollectionRef() { const { appId, db, api } = window.firebaseServices; return api.collection(db, `artifacts/${appId}/public/data/products`); },
        
        listenForProducts() { const productsCollectionRef = this.getProductsCollectionRef(); if (!productsCollectionRef) return; if (this.state.unsubscribeProducts) this.state.unsubscribeProducts(); this.state.unsubscribeProducts = window.firebaseServices.api.onSnapshot(productsCollectionRef, (querySnapshot) => { const products = []; querySnapshot.forEach(doc => { products.push({ id: doc.id, ...doc.data() }); }); this.state.productsFromFirestore = products.sort((a, b) => (a.productName || '').localeCompare(b.productName || '')); this.prepareSearchableProducts(); this.renderProductList(); }, (error) => { console.error("Error listening for products:", error); this.showInfoModal("ข้อผิดพลาด", "ไม่สามารถโหลดรายการสินค้าจากฐานข้อมูลได้", true); }); },
        
        getPriceForQuantity(pricingUnit, quantity) {
            if (!pricingUnit) return 0;
            let applicablePrice = -1;
            if (pricingUnit.priceTiers && pricingUnit.priceTiers.length > 0) {
                 // Tiers are sorted high to low quantity. Find the first tier the quantity qualifies for.
                 for (const tier of pricingUnit.priceTiers) {
                     if (quantity >= tier.quantity) {
                         applicablePrice = tier.price;
                         break;
                     }
                 }
            }
            // If the calculated price is 0 or wasn't found, use the default fallback price.
            if (applicablePrice <= 0) {
                return pricingUnit.defaultPrice || 0;
            }
            return applicablePrice;
        },

        prepareSearchableProducts() {
             const flatList = [];
             this.state.productsFromFirestore.forEach(product => {
                 if (product.pricingUnits && Array.isArray(product.pricingUnits)) {
                     product.pricingUnits.forEach(unit => {
                         const basePrice = this.getPriceForQuantity(unit, 1);
                         const searchableItem = {
                             productId: product.id,
                             productName: product.productName,
                             category: product.category || '',
                             baseUnit: product.baseUnit || '',
                             stockInBaseUnits: product.stockInBaseUnits || 0,
                             pricingUnit: unit,
                             display: `${product.productName} (${unit.unitName})`,
                             barcode: unit.barcode || '',
                             price: basePrice,
                             _searchableText: [product.productCode, product.productName, product.category, unit.unitName, unit.barcode].join(' ').toLowerCase().replace(/\s+/g, ' ')
                         };
                         flatList.push(searchableItem);
                     });
                 }
             });
             this.state.searchableProductUnits = flatList;
        },
        
        async handleSaveProduct(e) {
            e.preventDefault();
            this.state.isSaving = true;
            const productCode = document.getElementById('product-code').value.trim();
            const productName = document.getElementById('product-name').value.trim();
            if (!productCode || !productName) {
                this.showInfoModal("ข้อมูลไม่ครบ", "กรุณากรอกรหัสสินค้าและชื่อสินค้า", true);
                this.state.isSaving = false;
                return;
            }

            const pricingUnitCards = document.querySelectorAll('.pricing-unit-card');
            const pricingUnits = [];
            let formIsValid = true;

            pricingUnitCards.forEach(card => {
                const priceTierRows = card.querySelectorAll('.price-tier-row');
                let priceTiers = [];
                priceTierRows.forEach(row => {
                    const quantity = parseInt(row.querySelector('input[data-field="tier-qty"]').value, 10);
                    const price = parseFloat(row.querySelector('input[data-field="tier-price"]').value);
                    if (!isNaN(quantity) && quantity > 0 && !isNaN(price)) {
                        priceTiers.push({ quantity, price });
                    } else {
                        formIsValid = false;
                    }
                });

                if (priceTiers.length === 0) {
                    formIsValid = false;
                }

                priceTiers.sort((a, b) => b.quantity - a.quantity);
                const defaultPrice = priceTiers.find(t => t.quantity === 1)?.price || priceTiers[priceTiers.length - 1]?.price || 0;

                const unit = {
                    unitName: card.querySelector('input[data-field="unitName"]').value.trim(),
                    barcode: card.querySelector('input[data-field="barcode"]').value.trim(),
                    cost: parseFloat(card.querySelector('input[data-field="cost"]').value) || 0,
                    conversionFactor: parseInt(card.querySelector('input[data-field="conversionFactor"]').value, 10) || 1,
                    defaultPrice: defaultPrice,
                    priceTiers: priceTiers
                };
                if (!unit.unitName) formIsValid = false;
                pricingUnits.push(unit);
            });


            if (!formIsValid) {
                this.showInfoModal("ข้อมูลไม่ถูกต้อง", "กรุณาตรวจสอบข้อมูลในหน่วยราคาขาย, ต้องมีอย่างน้อย 1 ระดับราคาที่ถูกต้อง", true);
                this.state.isSaving = false;
                return;
            }
            
            const productData = {
                productCode: productCode,
                productName: productName,
                category: document.getElementById('product-category').value.trim(),
                baseUnit: document.getElementById('product-base-unit').value.trim(),
                stockInBaseUnits: parseInt(document.getElementById('product-stock').value, 10) || 0,
                pricingUnits: pricingUnits,
                updatedAt: new Date().toISOString()
            };

            try {
                const { api, db } = window.firebaseServices;
                if (this.state.currentEditingProductId) {
                    const docRef = api.doc(db, this.getProductsCollectionRef().path, this.state.currentEditingProductId);
                    await api.setDoc(docRef, productData, { merge: true });
                } else {
                    productData.createdAt = new Date().toISOString();
                    await api.addDoc(this.getProductsCollectionRef(), productData);
                }
                this.showInfoModal("สำเร็จ", "บันทึกข้อมูลสินค้าเรียบร้อยแล้ว");
                this.hideProductEditorModal();
            } catch (error) {
                console.error("Error saving product:", error);
                this.showInfoModal("ผิดพลาด", `เกิดข้อผิดพลาดในการบันทึกข้อมูล: ${error.message}`, true);
            } finally {
                this.state.isSaving = false;
            }
        },
        
        async handleDeleteProduct(productId) { const productToDelete = this.state.productsFromFirestore.find(p => p.id === productId); if (!productToDelete) return; const confirmation = confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบสินค้า "${productToDelete.productName}"? การกระทำนี้ไม่สามารถย้อนกลับได้`); if (confirmation) { try { const { api, db } = window.firebaseServices; const docRef = api.doc(db, this.getProductsCollectionRef().path, productId); await api.deleteDoc(docRef); this.showInfoModal("สำเร็จ", `ลบสินค้า "${productToDelete.productName}" เรียบร้อยแล้ว`); } catch (error) { console.error("Error deleting product:", error); this.showInfoModal("ผิดพลาด", `เกิดข้อผิดพลาดในการลบข้อมูล: ${error.message}`, true); } } },
        
        showProductMgmtModal() { document.getElementById('product-mgmt-modal').style.display = 'flex'; },
        hideProductMgmtModal() { document.getElementById('product-mgmt-modal').style.display = 'none'; },
        
        showProductEditorModal(product = null) {
            this.state.currentEditingProductId = product ? product.id : null;
            const form = document.getElementById('product-editor-form');
            form.reset();
            document.getElementById('product-editor-title').textContent = product ? `แก้ไขสินค้า: ${product.productName}` : 'เพิ่มสินค้าใหม่';
            const unitsContainer = document.getElementById('pricing-units-container');
            unitsContainer.innerHTML = '';
            
            const productCodeInput = document.getElementById('product-code');
            productCodeInput.disabled = !!product; // Disable editing product code for existing products

            if (product) {
                productCodeInput.value = product.productCode || '';
                document.getElementById('product-name').value = product.productName || '';
                document.getElementById('product-category').value = product.category || '';
                document.getElementById('product-base-unit').value = product.baseUnit || '';
                document.getElementById('product-stock').value = product.stockInBaseUnits || 0;
                (product.pricingUnits || []).forEach(unit => this.addPricingUnitRow(unit));
            } else {
                this.addPricingUnitRow(); // Add one default unit card for new product
            }
            document.getElementById('product-editor-modal').style.display = 'flex';
        },

        hideProductEditorModal() { document.getElementById('product-editor-modal').style.display = 'none'; },
        
        renderProductList() { const container = document.getElementById('product-list-container'); if (this.state.productsFromFirestore.length === 0) { container.innerHTML = '<p style="text-align:center; padding: 2rem;">ยังไม่มีสินค้าในระบบ, กด "เพิ่มสินค้าใหม่" หรือ "นำเข้าข้อมูล" เพื่อเริ่มต้น</p>'; return; } container.innerHTML = ` <div class="product-list-row" style="font-weight: bold; background-color: #e9ecef;"> <span>ชื่อสินค้า (รหัส)</span> <span>สต็อก</span> <span>หน่วยราคา</span> <span>การกระทำ</span> </div> ${this.state.productsFromFirestore.map(p => ` <div class="product-list-row"> <div> <strong>${p.productName}</strong> <div class="sub-text">${p.productCode || ''}</div> <div class="sub-text">${p.category || 'ไม่มีหมวดหมู่'}</div> </div> <div class="sub-text">${p.stockInBaseUnits} ${p.baseUnit}</div> <div class="sub-text">${(p.pricingUnits || []).map(u => `${u.unitName} (${this.getPriceForQuantity(u, 1)}฿)`).join(', ')}</div> <div> <button class="edit-history-btn" data-action="edit" data-id="${p.id}">แก้ไข</button> <button class="delete-history-btn" data-action="delete" data-id="${p.id}">ลบ</button> </div> </div> `).join('')} `; },
        
        addPricingUnitRow(unitData = null) {
            const container = document.getElementById('pricing-units-container');
            const card = document.createElement('div');
            card.className = 'pricing-unit-card';
            
            const priceTiers = (unitData && unitData.priceTiers && unitData.priceTiers.length > 0) ? unitData.priceTiers : [{ quantity: 1, price: 0 }];
            const priceTiersHTML = priceTiers.map(tier => this.createPriceTierRowHTML(tier.quantity, tier.price)).join('');

            card.innerHTML = `
                <div class="pricing-unit-header">
                    <h4>หน่วยขาย</h4>
                    <button type="button" class="delete-item-btn" data-action="remove-unit" title="ลบหน่วยนี้">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                    </button>
                </div>
                <div class="pricing-unit-grid">
                    <div class="form-group"> <label>ชื่อหน่วย</label> <input type="text" data-field="unitName" placeholder="เช่น ชิ้น, แพ็ค" value="${unitData?.unitName || ''}" required> </div>
                    <div class="form-group"> <label>บาร์โค้ด (ถ้ามี)</label> <input type="text" data-field="barcode" value="${unitData?.barcode || ''}"> </div>
                    <div class="form-group"> <label>ต้นทุน/หน่วยนี้</label> <input type="number" step="0.01" data-field="cost" value="${unitData?.cost || 0}"> </div>
                    <div class="form-group"> <label>ตัวคูณ (เทียบกับหน่วยเล็ก)</label> <input type="number" step="1" data-field="conversionFactor" placeholder="1 แพ็ค = 6 ชิ้น (ใส่ 6)" value="${unitData?.conversionFactor || 1}" required> </div>
                </div>
                <div class="price-tiers-container">
                    <label style="font-weight:bold; font-size: 0.9em;">ราคาขายตามจำนวน</label>
                    <div class="price-tier-header">
                        <div>ขั้นต่ำ (ชิ้น)</div>
                        <div>ราคา/หน่วย</div>
                        <div></div>
                    </div>
                    <div class="price-tiers-list">${priceTiersHTML}</div>
                    <button type="button" class="add-tier-btn" data-action="add-tier"> + เพิ่มระดับราคา</button>
                </div>
            `;
            container.appendChild(card);
        },

        createPriceTierRowHTML(quantity = 1, price = 0) {
            return `
                <div class="price-tier-row">
                    <input type="number" class="item-input" data-field="tier-qty" value="${quantity}" min="1" required>
                    <input type="number" class="item-input" data-field="tier-price" value="${price}" min="0" step="any" required>
                    <button type="button" class="delete-item-btn" data-action="remove-tier" title="ลบระดับราคานี้">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>`;
        },

        handleAddPricingUnit() { this.addPricingUnitRow(); },
        handlePricingUnitActions(e) { 
            const button = e.target.closest('button'); 
            if (!button) return; 
            const action = button.dataset.action; 
            if (action === 'remove-unit') { 
                const card = button.closest('.pricing-unit-card');
                if (card.parentElement.children.length > 1) {
                    card.remove(); 
                } else {
                    alert('ต้องมีหน่วยขายอย่างน้อย 1 หน่วย');
                }
            } else if (action === 'add-tier') { 
                const list = button.previousElementSibling; 
                list.insertAdjacentHTML('beforeend', this.createPriceTierRowHTML(1, 0)); 
            } else if (action === 'remove-tier') { 
                const row = button.closest('.price-tier-row'); 
                if (row.parentElement.children.length > 1) { 
                    row.remove(); 
                } else { 
                    alert('ต้องมีระดับราคาอย่างน้อย 1 ระดับ'); 
                } 
            } 
        },
        handleProductListActions(e) { const target = e.target.closest('button'); if (!target) return; const action = target.dataset.action; const id = target.dataset.id; if (action === 'edit') { const productToEdit = this.state.productsFromFirestore.find(p => p.id === id); if (productToEdit) this.showProductEditorModal(productToEdit); } else if (action === 'delete') { this.handleDeleteProduct(id); } },
        
        handleInstantSearch(e) { const query = e.target.value.toLowerCase().trim(); const quantityPattern = /^(\d+)\s*\*\s*(.+)$/; const match = query.match(quantityPattern); let effectiveQuery = match ? match[2].trim() : query; if (effectiveQuery.length < 1) { this.state.currentSearchResults = []; this.state.selectedSearchIndex = -1; this.displaySearchResults([]); return; } const translatedQuery = this.translateThaiToEng(effectiveQuery); const queryTerms = translatedQuery.split(' ').filter(term => term.length > 0); this.state.currentSearchResults = this.state.searchableProductUnits.filter(p => { return queryTerms.every(term => p._searchableText.includes(term)); }); this.state.selectedSearchIndex = this.state.currentSearchResults.length > 0 ? 0 : -1; this.displaySearchResults(this.state.currentSearchResults); },
        
        displaySearchResults(results) { const resultsContainer = document.getElementById('search-results'); resultsContainer.innerHTML = ''; if (results.length > 0) { resultsContainer.classList.add('has-results'); } else { resultsContainer.classList.remove('has-results'); } if (results.length === 0) return; results.forEach((productUnit, index) => { const itemDiv = document.createElement('div'); itemDiv.className = 'search-item'; if (index === this.state.selectedSearchIndex) itemDiv.classList.add('selected'); itemDiv.innerHTML = `<div><span>${productUnit.display}</span></div><span class="price" style="color:var(--success-color); font-weight:bold;">${parseFloat(productUnit.price).toFixed(2)} ฿</span>`; itemDiv.onclick = () => { const inputValue = document.getElementById('barcode-input').value.trim(); const quantityPattern = /^(\d+)\s*\*\s*(.+)$/; const match = inputValue.match(quantityPattern); let quantityToAdd = 1; if (match) { quantityToAdd = parseInt(match[1], 10); } this.addToCart(this.state.currentSearchResults[index], quantityToAdd); document.getElementById('barcode-input').value = ''; this.state.currentSearchResults = []; this.state.selectedSearchIndex = -1; this.displaySearchResults([]); }; resultsContainer.appendChild(itemDiv); }); },
        
        addToCart(productUnit, quantityToAdd = 1) { const cart = this.getActiveCart(); if (!cart) return; const cartItemId = productUnit.barcode || `${productUnit.productId}-${productUnit.pricingUnit.unitName}`; const existingProduct = cart.find(item => item.cartItemId === cartItemId); if (existingProduct) { existingProduct.quantity += quantityToAdd; } else { const newItem = { cartItemId: cartItemId, productUnit: productUnit, quantity: quantityToAdd }; cart.push(newItem); } this.updateCartDisplay(); },
        
        updateCartDisplay() {
            const cart = this.getActiveCart();
            const discount = this.getActiveDiscount();
            document.getElementById('discount-input').value = discount || '';
            const cartItemsElement = document.getElementById('cart-items');
            cartItemsElement.innerHTML = '';
            if (!cart) return;
            let subtotal = 0;
            cart.forEach((item, index) => {
                const { productUnit, quantity } = item;
                const currentPrice = this.getPriceForQuantity(productUnit.pricingUnit, quantity);
                const totalForItem = currentPrice * quantity;
                subtotal += totalForItem;
                const li = document.createElement('li');
                const stockInThisUnit = productUnit.stockInBaseUnits / productUnit.pricingUnit.conversionFactor;
                let itemInfoHTML = `<strong>${productUnit.display}</strong>`;
                if (!this.state.isRestrictedMode) { itemInfoHTML += ` <span class="sub-text">(คงเหลือ: ${stockInThisUnit.toFixed(2)} ${productUnit.pricingUnit.unitName})(ต้นทุน: ${(productUnit.pricingUnit.cost || 0).toFixed(2)})</span>`; }
                li.innerHTML = `
                    <div class="col-seq">${index + 1}.</div>
                    <div class="col-name">${itemInfoHTML}</div>
                    <div class="col-qty"><input type="number" class="item-input" value="${quantity}" onchange="POS_APP.editItemQuantity(${index}, this.value)" onfocus="this.select()"></div>
                    <div class="col-price col-right"><input type="text" class="item-input" value="${currentPrice.toFixed(2)}" disabled></div>
                    <div class="col-total col-right"><input type="text" class="item-input" value="${totalForItem.toFixed(2)}" disabled></div>
                    <div class="col-delete col-center"><button class="delete-item-btn" onclick="POS_APP.deleteItemFromCart(${index})"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button></div>`;
                cartItemsElement.appendChild(li);
            });
            const total = subtotal - (discount || 0);
            document.getElementById('cart-subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('cart-total').textContent = total.toFixed(2);
        },
        
        showInfoModal(title, text, isError = false) { const titleEl = document.getElementById('info-modal-title'); const textEl = document.getElementById('info-modal-text'); const okBtn = document.getElementById('info-modal-ok-btn'); titleEl.textContent = title; titleEl.style.color = isError ? 'var(--danger-color)' : 'var(--primary-color)'; textEl.textContent = text; okBtn.style.backgroundColor = isError ? 'var(--danger-color)' : 'var(--primary-color)'; document.getElementById('info-modal').style.display = 'flex'; this.state.activeModalCloseHandler = (e) => { if (e.key === 'Enter' || e.key === 'Escape') { e.preventDefault(); this.hideInfoModal(); } }; document.addEventListener('keydown', this.state.activeModalCloseHandler); okBtn.focus(); },
        hideInfoModal() { document.getElementById('info-modal').style.display = 'none'; if (this.state.activeModalCloseHandler) { document.removeEventListener('keydown', this.state.activeModalCloseHandler); this.state.activeModalCloseHandler = null; } },
        updatePlaceholderHint() { const input = document.getElementById('barcode-input'); if (input) input.placeholder = `[${this.state.keyboardLayout}] ${this.state.basePlaceholder}`; },
        detectKeyboardLayout(e) { if (e.key.length !== 1 || e.ctrlKey || e.altKey || e.metaKey) return; const isThai = /[ก-๙]/.test(e.key); if (isThai && this.state.keyboardLayout !== 'TH') { this.state.keyboardLayout = 'TH'; this.updatePlaceholderHint(); } else if (!isThai && this.state.keyboardLayout !== 'ENG') { this.state.keyboardLayout = 'ENG'; this.updatePlaceholderHint(); } },
        handleSearchKeyDown(e) { if (e.key === 'Enter') { e.preventDefault(); const inputValue = document.getElementById('barcode-input').value.trim(); if (inputValue === '0000000000') { this.state.isRestrictedMode = true; this.toggleUIVisibility(); document.getElementById('barcode-input').value = ''; this.displaySearchResults([]); return; } else if (inputValue === '1111111111') { this.state.isRestrictedMode = false; this.toggleUIVisibility(); document.getElementById('barcode-input').value = ''; this.displaySearchResults([]); return; } const quantityPattern = /^(\d+)\s*\*\s*(.+)$/; const match = inputValue.match(quantityPattern); if (this.state.currentSearchResults.length > 0 && this.state.selectedSearchIndex !== -1) { let quantityToAdd = 1; if (match) { quantityToAdd = parseInt(match[1], 10); } this.addToCart(this.state.currentSearchResults[this.state.selectedSearchIndex], quantityToAdd); document.getElementById('barcode-input').value = ''; this.state.currentSearchResults = []; this.state.selectedSearchIndex = -1; this.displaySearchResults([]); } else if (this.getActiveCart().length > 0 && inputValue === '') { document.getElementById('discount-input').focus(); document.getElementById('discount-input').select(); } } else if (e.key === 'ArrowDown') { e.preventDefault(); this.navigateSearchResults(1); } else if (e.key === 'ArrowUp') { e.preventDefault(); this.navigateSearchResults(-1); } },
        handleGlobalKeyDown(e) { if (this.state.activeModalCloseHandler) return; if (e.ctrlKey && (e.key === 'Tab' || e.key === 'ArrowRight' || e.key === 'ArrowLeft')) { e.preventDefault(); const direction = (e.shiftKey || e.key === 'ArrowLeft') ? -1 : 1; this.navigateTabs(direction); } else if (e.ctrlKey && e.key === 'w') { e.preventDefault(); if(this.state.activeTabId) this.closeTab(this.state.activeTabId); } else if (e.key === 'Delete') { e.preventDefault(); if(this.state.activeTabId) this.closeTab(this.state.activeTabId, true); } else if (e.key === 'F9') { e.preventDefault(); this.showPaymentModal(); } else if (e.key === 'F5') { e.preventDefault(); document.getElementById('barcode-input').focus(); } else if (e.key === 'F11') { e.preventDefault(); document.getElementById('discount-input').focus(); document.getElementById('discount-input').select(); } else if (e.key === 'F2') { e.preventDefault(); this.addNewSaleTab(); } else if (e.key === 'F8') { e.preventDefault(); this.showClearCartConfirmModal(); } else if (e.key === 'Escape') { if (document.getElementById('payment-modal').style.display === 'flex') { e.preventDefault(); this.hidePaymentModal(); } if (document.getElementById('delete-confirm-modal').style.display === 'flex') { e.preventDefault(); this.hideDeleteConfirmModal(); } if (document.getElementById('clear-options-modal').style.display === 'flex') { e.preventDefault(); this.hideClearOptionsModal(); } if (document.getElementById('product-mgmt-modal').style.display === 'flex') { e.preventDefault(); this.hideProductMgmtModal(); } if (document.getElementById('product-editor-modal').style.display === 'flex') { e.preventDefault(); this.hideProductEditorModal(); } } },
        navigateSearchResults(direction) { if (this.state.currentSearchResults.length === 0) return; this.state.selectedSearchIndex += direction; if (this.state.selectedSearchIndex < 0) this.state.selectedSearchIndex = this.state.currentSearchResults.length - 1; else if (this.state.selectedSearchIndex >= this.state.currentSearchResults.length) this.state.selectedSearchIndex = 0; this.updateSelectedSearchResult(); },
        updateSelectedSearchResult() { const items = document.querySelectorAll('.search-item'); items.forEach((item, index) => { if (index === this.state.selectedSearchIndex) { item.classList.add('selected'); item.scrollIntoView({ block: 'nearest' }); } else { item.classList.remove('selected'); } }); },
        translateThaiToEng(input) { return input.split('').map(char => this.config.thaiToEngMap[char] || char).join(''); },
        getActiveCart() { if (!this.state.activeTabId || !this.state.tabs.has(this.state.activeTabId)) return []; return this.state.tabs.get(this.state.activeTabId).cart; },
        getActiveDiscount() { if (!this.state.activeTabId || !this.state.tabs.has(this.state.activeTabId)) return 0; return this.state.tabs.get(this.state.activeTabId).discount; },
        setActiveDiscount(value) { if (this.state.activeTabId && this.state.tabs.has(this.state.activeTabId)) { this.state.tabs.get(this.state.activeTabId).discount = value; } },
        editItemQuantity(index, newQuantityString) { const cart = this.getActiveCart(); const newQuantity = parseInt(newQuantityString, 10); if (isNaN(newQuantity) || newQuantity <= 0) { cart.splice(index, 1); } else { const item = cart[index]; if (item) item.quantity = newQuantity; } this.updateCartDisplay(); },
        deleteItemFromCart(index) { const cart = this.getActiveCart(); cart.splice(index, 1); this.updateCartDisplay(); },
        clearCart() { const tabData = this.state.tabs.get(this.state.activeTabId); if (tabData && tabData.cart.length > 0) { tabData.cart = []; tabData.discount = 0; this.updateCartDisplay(); } },
        showClearCartConfirmModal() { const cart = this.getActiveCart(); if (cart.length === 0) return; const confirmBtn = document.getElementById('confirm-delete-btn'); const confirmText = document.getElementById('delete-confirm-text'); confirmText.textContent = `คุณแน่ใจหรือไม่ว่าต้องการล้างตะกร้าสินค้าทั้งหมด?`; confirmBtn.onclick = () => { this.clearCart(); this.hideDeleteConfirmModal(); }; document.getElementById('delete-confirm-modal').style.display = 'flex'; confirmBtn.focus(); },
        updateCartOnInput(){ const discountValue = parseFloat(document.getElementById('discount-input').value) || 0; this.setActiveDiscount(discountValue); this.updateCartDisplay(); },
        showPaymentModal() { const cart = this.getActiveCart(); if (cart.length === 0) return; const subtotal = parseFloat(document.getElementById('cart-subtotal').textContent); const discount = this.getActiveDiscount(); const finalTotal = subtotal - discount; document.getElementById('payment-total-final').textContent = finalTotal.toFixed(2); document.getElementById('payment-change').textContent = "0.00"; const cashInput = document.getElementById('cash-received-input'); cashInput.value = ''; document.getElementById('payment-modal').style.display = 'flex'; cashInput.focus(); },
        hidePaymentModal() { document.getElementById('payment-modal').style.display = 'none'; document.getElementById('barcode-input').focus(); },
        calculateChange() { const total = parseFloat(document.getElementById('payment-total-final').textContent); const cashReceived = parseFloat(document.getElementById('cash-received-input').value) || 0; const change = cashReceived - total; const changeEl = document.getElementById('payment-change'); if (change >= 0) { changeEl.textContent = change.toFixed(2); changeEl.style.color = 'var(--success-color)'; } else { changeEl.textContent = 'เงินไม่พอ'; changeEl.style.color = 'var(--danger-color)'; } },
        async confirmSale() { if (this.state.isSaving) return; const collectionRef = this.getSalesHistoryCollectionRef(); if (!collectionRef) { this.showInfoModal("ข้อผิดพลาด", "ยังไม่ได้เชื่อมต่อกับฐานข้อมูล กรุณารอสักครู่แล้วลองอีกครั้ง", true); return; } const cart = this.getActiveCart(); const discount = this.getActiveDiscount(); const subtotal = cart.reduce((sum, item) => sum + (this.getPriceForQuantity(item.productUnit.pricingUnit, item.quantity) * item.quantity), 0); const finalTotal = subtotal - discount; const cashReceived = parseFloat(document.getElementById('cash-received-input').value) || 0; if (cashReceived < finalTotal) { this.showInfoModal("ข้อผิดพลาด", "จำนวนเงินที่รับมาไม่เพียงพอ", true); return; } this.state.isSaving = true; const confirmButton = document.getElementById('confirm-sale-btn'); confirmButton.disabled = true; const newSaleId = await this.generateSaleId(); const saleRecordItems = cart.map(item => ({ cartItemId: item.cartItemId, name: item.productUnit.display, unit: item.productUnit.pricingUnit.unitName, quantity: item.quantity, price: this.getPriceForQuantity(item.productUnit.pricingUnit, item.quantity), cost: item.productUnit.pricingUnit.cost || 0, })); const saleRecord = { id: newSaleId, timestamp: new Date().toISOString(), items: saleRecordItems, subtotal: subtotal, discount: discount, total: finalTotal, cashReceived: cashReceived, change: cashReceived - finalTotal, }; try { await window.firebaseServices.api.addDoc(collectionRef, saleRecord); const tabToDelete = this.state.activeTabId; document.getElementById('edit-status').style.display = 'none'; this.hidePaymentModal(); this.closeTab(tabToDelete, false); } catch (e) { console.error("Error adding document: ", e); this.showInfoModal("ข้อผิดพลาด", "เกิดข้อผิดพลาดในการบันทึกข้อมูลการขาย!", true); } finally { this.state.isSaving = false; confirmButton.disabled = false; } },
        editSaleRecord(firestoreId) { console.log("Edit sale record:", firestoreId); },
        showDeleteConfirmModal(id, isTab) { const confirmBtn = document.getElementById('confirm-delete-btn'); const confirmText = document.getElementById('delete-confirm-text'); if (isTab) { const tabData = this.state.tabs.get(id); confirmText.textContent = `คุณแน่ใจหรือไม่ว่าต้องการปิดบิล '${tabData.name}'?`; confirmBtn.onclick = () => { this.closeTab(id, false); this.hideDeleteConfirmModal(); }; } else { const sale = this.state.salesHistory.find(s => s.firestoreId === id); confirmText.textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบรายการขาย ID: ${sale ? sale.id : id}? การกระทำนี้ไม่สามารถย้อนกลับได้`; confirmBtn.onclick = () => this.executeDeleteSaleFromHistory(id); } document.getElementById('delete-confirm-modal').style.display = 'flex'; setTimeout(() => confirmBtn.focus(), 50); },
        hideDeleteConfirmModal() { document.getElementById('delete-confirm-modal').style.display = 'none'; },
        async executeDeleteSaleFromHistory(firestoreId) { const {api, db} = window.firebaseServices; const docRef = api.doc(db, this.getSalesHistoryCollectionRef().path, firestoreId); this.hideDeleteConfirmModal(); try { await api.deleteDoc(docRef); console.log("Deleted sale record:", firestoreId); } catch (e) { console.error("Error deleting document: ", e); this.showInfoModal("ผิดพลาด", "เกิดข้อผิดพลาดในการลบข้อมูล!", true); } },
        showClearOptionsModal() { document.getElementById('clear-options-modal').style.display = 'flex'; },
        hideClearOptionsModal() { document.getElementById('clear-options-modal').style.display = 'none'; },
        clearHistoryLocally() { this.state.salesHistory = []; this.updateHistoryDisplay(); this.calculateSummaryForDisplayedHistory(); this.hideClearOptionsModal(); },
        async executeClearAllHistory() { this.hideClearOptionsModal(); const salesCollection = this.getSalesHistoryCollectionRef(); try { const querySnapshot = await window.firebaseServices.api.getDocs(salesCollection); const batch = window.firebaseServices.api.writeBatch(window.firebaseServices.db); querySnapshot.forEach((doc) => { batch.delete(doc.ref); }); await batch.commit(); } catch (e) { this.showInfoModal("ผิดพลาด", "เกิดข้อผิดพลาดในการล้างประวัติทั้งหมด!", true); } },
        updateHistoryDisplay() { const historyBody = document.getElementById('history-body'); const clearHistoryBtn = document.getElementById('clear-all-history-btn'); if (!historyBody) return; historyBody.innerHTML = ''; const now = new Date(); const startOfCurrentHour = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours()); if (this.state.salesHistory.length === 0) { historyBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">ไม่พบประวัติการขาย</td></tr>'; if(clearHistoryBtn) clearHistoryBtn.disabled = true; return; } if(clearHistoryBtn) clearHistoryBtn.disabled = false; this.state.salesHistory.forEach((sale) => { const row = historyBody.insertRow(); const saleTimestamp = new Date(sale.timestamp); if (saleTimestamp < startOfCurrentHour) { row.classList.add('exported-row'); row.title = 'รายการนี้ถูก Export แล้วโดยระบบอัตโนมัติ'; } const itemDetails = sale.items.map(item => `${item.name} (x${item.quantity})`).join('<br>'); const discountAmount = sale.discount ? sale.discount.toFixed(2) : '0.00'; let actionCellHTML = ''; if (!this.state.isRestrictedMode) { actionCellHTML = `<button class="edit-history-btn" onclick="POS_APP.editSaleRecord('${sale.firestoreId}')">แก้ไข</button><button class="delete-history-btn" onclick="POS_APP.showDeleteConfirmModal('${sale.firestoreId}', false)">ลบ</button>`; } row.innerHTML = `<td>${new Date(sale.timestamp).toLocaleString('th-TH')}</td><td>${sale.id}</td><td>${itemDetails}</td><td>${discountAmount}</td><td><strong>${sale.total.toFixed(2)}</strong></td><td style="white-space: nowrap;">${actionCellHTML}</td>`; }); },
        toggleUIVisibility() { const summarySection = document.getElementById('sales-summary-section'); const filterSection = document.querySelector('.filter-section'); if (this.state.isRestrictedMode) { if (summarySection) summarySection.style.display = 'none'; if (filterSection) filterSection.style.display = 'none'; } else { if (summarySection) summarySection.style.display = 'block'; if (filterSection) filterSection.style.display = 'flex'; } this.updateHistoryDisplay(); this.updateCartDisplay(); },
        addNewSaleTab() { if (this.state.tabs.size >= 5) { this.showInfoModal("ไม่สามารถเปิดบิล", "ไม่สามารถเปิดบิลใหม่ได้เกิน 5 บิล", false); return; } let nextSaleNumber = 1; const usedNumbers = Array.from(this.state.tabs.values()).map(t => t.name ? parseInt(t.name.split(' ')[1]) : 0); while(usedNumbers.includes(nextSaleNumber)) { nextSaleNumber++; } const tabId = 'sale-' + Date.now(); this.state.tabs.set(tabId, { cart: [], discount: 0, name: `บิล ${nextSaleNumber}`, }); this.renderTabs(); this.switchTab(tabId); },
        switchTab(tabId) { if (!this.state.tabs.has(tabId)) return; this.state.activeTabId = tabId; this.renderTabs(); this.updateCartDisplay(); document.getElementById('barcode-input').focus(); },
        closeTab(tabId, confirm = true) { const tabData = this.state.tabs.get(tabId); if (!tabData) return; if (confirm && tabData.cart.length > 0) { this.showDeleteConfirmModal(tabId, true); return; } this.state.tabs.delete(tabId); if (this.state.activeTabId === tabId) { const remainingTabs = Array.from(this.state.tabs.keys()); if (remainingTabs.length > 0) { this.switchTab(remainingTabs[0]); } else { this.addNewSaleTab(); } } this.renderTabs(); },
        renderTabs() { const tabsContainer = document.getElementById('cart-tabs'); if (!tabsContainer) return; tabsContainer.innerHTML = ''; const self = this; this.state.tabs.forEach((data, id) => { const tabButton = document.createElement('button'); tabButton.className = 'tab-button'; tabButton.textContent = data.name; tabButton.onclick = () => self.switchTab(id); if (id === this.state.activeTabId) { tabButton.classList.add('active'); } if (this.state.tabs.size > 1) { const closeButton = document.createElement('button'); closeButton.className = 'close-tab-btn'; closeButton.innerHTML = '&times;'; closeButton.onclick = (e) => { e.stopPropagation(); self.closeTab(id); }; tabButton.appendChild(closeButton); } tabsContainer.appendChild(tabButton); }); },
        navigateTabs(direction) { const tabKeys = Array.from(this.state.tabs.keys()); if(tabKeys.length <= 1) return; let currentIndex = tabKeys.indexOf(this.state.activeTabId); currentIndex += direction; if (currentIndex >= tabKeys.length) { currentIndex = 0; } else if (currentIndex < 0) { currentIndex = tabKeys.length - 1; } this.switchTab(tabKeys[currentIndex]); },
        filterHistoryByDateTime() { const startDateInput = document.getElementById('start-date').value; const startTimeInput = document.getElementById('start-time').value; const endDateInput = document.getElementById('end-date').value; const endTimeInput = document.getElementById('end-time').value; if (!startDateInput || !endDateInput) { this.showInfoModal("ข้อมูลไม่ครบถ้วน", "กรุณาเลือกทั้งวันที่เริ่มต้นและวันที่สิ้นสุด", false); return; } const startDateTime = new Date(`${startDateInput}T${startTimeInput || '00:00:00'}`); const endDateTime = new Date(`${endDateInput}T${endTimeInput || '23:59:59'}`); this.loadSalesHistoryFromFirestore(startDateTime.toISOString(), endDateTime.toISOString()); },
        filterHistoryForToday() { const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0); const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999); document.getElementById('start-date').value = todayStart.toISOString().split('T')[0]; document.getElementById('start-time').value = '00:00'; document.getElementById('end-date').value = todayEnd.toISOString().split('T')[0]; document.getElementById('end-time').value = '23:59'; this.loadSalesHistoryFromFirestore(todayStart.toISOString(), todayEnd.toISOString()); },
        loadSalesHistoryFromFirestore(startDate, endDate) { const historyCollectionRef = this.getSalesHistoryCollectionRef(); if (!historyCollectionRef) return; if (this.state.unsubscribeSalesHistory) { this.state.unsubscribeSalesHistory(); } const { query, where } = window.firebaseServices.api; let q; document.getElementById('summary-title').textContent = `สรุปยอดขาย`; if (startDate && endDate) { q = query(historyCollectionRef, where("timestamp", ">=", startDate), where("timestamp", "<=", endDate) ); } else { q = query(historyCollectionRef); } this.state.unsubscribeSalesHistory = window.firebaseServices.api.onSnapshot(q, (querySnapshot) => { const newHistory = []; querySnapshot.forEach((doc) => { newHistory.push({ ...doc.data(), firestoreId: doc.id }); }); this.state.salesHistory = newHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); this.updateHistoryDisplay(); this.calculateSummaryForDisplayedHistory(); }, (error) => { console.error("Error loading sales history:", error); if (error.code === 'permission-denied') { this.showInfoModal("ข้อผิดพลาด Firestore", "การเชื่อมต่อ Firestore ล้มเหลว! (permission-denied)", true); } }); },
        calculateSummaryForDisplayedHistory() { const displayedSales = this.state.salesHistory; let totalSales = 0; let totalDiscount = 0; let netSales = 0; let totalCost = 0; displayedSales.forEach(sale => { totalSales += sale.subtotal || 0; totalDiscount += sale.discount || 0; netSales += sale.total || 0; if (sale.items && Array.isArray(sale.items)) { sale.items.forEach(item => { const cost = item.cost || 0; const quantity = item.quantity || 0; totalCost += cost * quantity; }); } }); const billCount = displayedSales.length; const profit = netSales - totalCost; const formatCurrency = (number) => number.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); document.getElementById('summary-total-sales').textContent = formatCurrency(totalSales); document.getElementById('summary-total-discount').textContent = formatCurrency(totalDiscount); document.getElementById('summary-net-sales').textContent = formatCurrency(netSales); document.getElementById('summary-bill-count').textContent = billCount.toLocaleString('en-US'); document.getElementById('summary-profit').textContent = formatCurrency(profit); },
        async generateSaleId() { const today = new Date(); const datePrefix = `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}`; if (this.state.lastSaleDate !== datePrefix) { this.state.dailySaleCounter = 0; this.state.lastSaleDate = datePrefix; } const todaySalesInHistory = this.state.salesHistory.filter(sale => sale.id && sale.id.startsWith(datePrefix)); this.state.dailySaleCounter = todaySalesInHistory.length + 1; return `${datePrefix}-${this.state.dailySaleCounter.toString().padStart(4, '0')}`; },
        exportToExcel() { const dataToExport = this.state.salesHistory.flatMap(sale => sale.items.map(item => ({ 'รหัสการขาย': sale.id, 'วันที่': new Date(sale.timestamp).toLocaleDateString('th-TH'), 'เวลา': new Date(sale.timestamp).toLocaleTimeString('th-TH'), 'ยอดรวมก่อนลด': sale.subtotal ? sale.subtotal.toFixed(2) : '0.00', 'ส่วนลด': sale.discount ? sale.discount.toFixed(2) : '0.00', 'ยอดสุทธิ': sale.total ? sale.total.toFixed(2) : '0.00', 'รหัสสินค้า': item.cartItemId, 'สินค้า': item.name, 'หน่วย': item.unit, 'จำนวน': item.quantity, 'ราคาต่อหน่วย': parseFloat(item.price), 'ต้นทุน': parseFloat(item.cost || 0), 'ราคารวม (รายการนี้)': item.price * item.quantity })) ); if (dataToExport.length === 0) { this.showInfoModal("ไม่มีข้อมูล", "ไม่มีข้อมูลประวัติการขายให้ Export", false); return; } const worksheet = XLSX.utils.json_to_sheet(dataToExport); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, 'ประวัติการขาย'); worksheet['!cols'] = [ {wch:20}, {wch:12}, {wch:12}, {wch:15},{wch:15},{wch:15}, {wch:15},{wch:30},{wch:10}, {wch:10},{wch:15},{wch:15},{wch:15} ]; XLSX.writeFile(workbook, `pos-history-${new Date().toISOString().split('T')[0]}.xlsx`); },
    };

    document.addEventListener('DOMContentLoaded', () => {
        window.POS_APP = POS_APP;
        POS_APP.init();
    });
    </script>
</body>
</html>
