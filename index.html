<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบขายหน้าร้าน (POS)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --light-bg: #f8f9fa;
            --white-color: #ffffff;
            --dark-text: #343a40;
            --border-color: #dee2e6;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            margin: 0;
        }

        .body-content {
             padding: 1.5rem;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            max-width: 1400px;
            margin: auto;
        }

        .card {
            background-color: var(--white-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        h2, h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            margin-top: 0;
            font-size: 1.5rem;
        }
        
        h3 {
            font-size: 1.25rem;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            text-align: center;
        }
        .summary-item {
            background-color: #f1f3f5;
            padding: 1rem;
            border-radius: 8px;
        }
        .summary-item .label {
            font-size: 1em;
            color: var(--secondary-color);
        }
        .summary-item .value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .pos-layout {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 1.5rem;
        }
        
        .search-column, .cart-column {
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            font-size: 0.9em;
            color: var(--secondary-color);
            display: block;
            margin-bottom: 0.5rem;
        }

        #barcode-input {
            width: 100%; 
            padding: 0.75rem;
            font-size: 1.1em;
            box-sizing: border-box; 
            border: 1px solid var(--border-color); 
            border-radius: 4px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        #barcode-input:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        #search-results {
            margin-top: 1rem;
            overflow-y: hidden;
            border: 1px solid transparent;
            border-radius: 4px;
            height: 1px;
            min-height: 1px;
            transition: all 0.2s ease-in-out;
            flex-grow: 0;
        }

        #search-results.has-results {
            border-color: var(--border-color);
            min-height: 150px;
            height: auto;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .search-item {
            padding: 0.75rem; cursor: pointer; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between;
            align-items: center;
        }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover, .search-item.selected {
            background-color: var(--primary-color); color: var(--white-color);
        }
        .search-item.selected .price, .search-item.selected .sub-text { color: var(--white-color); }
        .search-item .sub-text {
            font-size: 0.8em;
            color: var(--secondary-color);
            font-weight: normal;
        }

        .cart-header-row {
            display: grid;
            grid-template-columns: 30px 1fr 120px 100px 110px 40px;
            gap: 0.75rem;
            padding: 0 0.75rem 0.5rem 0.75rem;
            font-weight: bold;
            color: var(--secondary-color);
            border-bottom: 2px solid var(--border-color);
            align-items: center;
        }
        
        .cart-header-row .col-name { text-align: left; }
        .cart-header-row .col-center { text-align: center; }
        .cart-header-row .col-right { text-align: right; }
        
        #cart-items {
            list-style-type: none; padding: 0; 
            overflow-y: auto; min-height: 300px;
            margin-top: 0.5rem;
            flex-grow: 1;
        }

        #cart-items li {
            background-color: #f1f3f5; 
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            display: grid;
            grid-template-columns: 30px 1fr 120px 100px 110px 40px;
            align-items: center; 
            gap: 0.75rem;
            font-size: 14px;
        }
        
        .item-input {
            text-align: right;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px;
            font-size: 14px;
            background-color: var(--white-color);
            width: 100%;
            box-sizing: border-box;
            -moz-appearance: textfield;
        }
        .item-input::-webkit-outer-spin-button,
        .item-input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        
        .col-qty {
            display: flex;
            align-items: center;
            gap: 5px;
        }
         .col-qty .item-input {
            width: 45px;
            text-align: center;
         }

        .delete-item-btn {
            background: transparent;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .delete-item-btn:hover {
            transform: scale(1.2);
        }

        .delete-item-btn svg {
            width: 18px;
            height: 18px;
        }

        .totals-section {
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            font-size: 1.2em;
            margin-bottom: 0.5rem;
            align-items: center;
        }
        .total-row label, .total-row span {
            font-weight: bold;
        }
        #discount-input {
            width: 120px;
            font-size: 1em;
            text-align: right;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px;
        }
        #cart-total {
            color: var(--success-color);
            font-size: 1.5em;
        }

        .button-group { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .button-group-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }

        button {
            background-color: var(--primary-color); color: white; border: none;
            padding: 0.75rem 1rem; border-radius: 4px; cursor: pointer;
            font-size: 1em; font-family: 'Sarabun', sans-serif;
            transition: background-color 0.3s, transform 0.1s;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        button:active { transform: scale(0.98); }
        button.finish-sale { background-color: var(--success-color); }
        button.clear-cart { background-color: var(--danger-color); }
        .delete-history-btn {
            background-color: var(--danger-color); padding: 0.25rem 0.75rem; font-size: 0.9em;
        }
        .edit-history-btn {
            background-color: var(--info-color); padding: 0.25rem 0.75rem;
            font-size: 0.9em; margin-right: 5px;
        }
        
        #history-table-wrapper {
            max-height: 600px; overflow-y: auto; border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        #history-table { width: 100%; border-collapse: collapse; }
        #history-table th, #history-table td { 
            border-bottom: 1px solid var(--border-color); padding: 0.75rem;
            text-align: left; vertical-align: middle;
        }
        #history-table th { background-color: #e9ecef; position: sticky; top: 0; }
        #history-table tr:nth-child(even) { background-color: var(--light-bg); }

        #history-table tr.exported-row {
            background-color: #f1f8e9;
            opacity: 0.8;
        }
        #history-table tr.exported-row:hover {
            opacity: 1;
        }
        #history-table tr.exported-row td {
             color: #555;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: var(--white-color); padding: 2rem; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px;
        }
        .modal-content h3 { margin-top: 0; }
        .modal-content p {
            white-space: pre-wrap;
            text-align: left;
            margin-bottom: 1.5rem;
        }
        
        .payment-modal-body {
            width: 100%;
            margin-top: 1.5rem;
        }
        .payment-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .payment-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .payment-label {
            font-size: 1.5em;
            color: var(--secondary-color);
        }
        .payment-amount {
            font-weight: bold;
        }
        #payment-total-final {
            font-size: 2.5em;
            color: var(--primary-color);
        }
        #cash-received-input {
            font-size: 2em;
            text-align: right;
            width: 50%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        #payment-change {
            font-size: 3em;
            color: var(--success-color);
        }

        /* Tabs System */
        .cart-tabs-container {
            display: flex;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
        }
        #cart-tabs {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 2px; /* For scrollbar space */
        }
        .tab-button {
            padding: 0.75rem 1rem;
            cursor: pointer;
            background-color: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            font-size: 1em;
            color: var(--secondary-color);
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: bold;
        }
        .close-tab-btn {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.2em;
            padding: 0 0 0 0.5rem;
            line-height: 1;
            opacity: 0.5;
            border-radius: 50%;
        }
        .close-tab-btn:hover {
            opacity: 1;
            background-color: rgba(0,0,0,0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .body-content {
                 padding: 0.5rem;
            }
            .card {
                 padding: 1rem;
            }
            .pos-layout {
                grid-template-columns: 1fr;
            }
            h2, h3 {
                font-size: 1.25rem;
            }
            h3 {
                font-size: 1.1rem;
            }
            .summary-grid {
                gap: 0.5rem;
            }
            .summary-item .value {
                font-size: 1.5em;
            }
            .payment-label {
                font-size: 1.2em;
            }
            #payment-total-final {
                font-size: 2em;
            }
            #cash-received-input {
                font-size: 1.5em;
            }
            #payment-change {
                font-size: 2.2em;
            }
            #cart-items li {
                gap: 0.5rem;
                font-size: 13px;
                padding: 0.5rem;
                grid-template-columns: 24px 1fr 80px 70px 80px 24px;
            }
            .cart-header-row {
                gap: 0.5rem;
                grid-template-columns: 24px 1fr 80px 70px 80px 24px;
            }
            .col-qty .item-input {
                width: 40px;
            }
            .delete-item-btn, .close-tab-btn {
                width: 24px;
                height: 24px;
                line-height: 24px;
                font-size: 1.2em;
            }
            .filter-section {
                flex-direction: column;
                align-items: stretch !important;
            }
            .filter-section input {
                width: 100%;
                box-sizing: border-box;
                margin-bottom: 0.5rem;
            }
            .filter-section button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="body-content">
        <main class="main-container">
            <section class="card">
                <div class="pos-layout">
                    <div class="search-column">
                        <h2><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>ค้นหาสินค้า</h2>
                        <div class="form-group">
                            <label for="barcode-input">F2:บิลใหม่ | F5:ค้นหา | F8:ล้าง | F9:ชำระเงิน | F11:ส่วนลด | Del:ปิดบิล</label>
                            <input type="text" id="barcode-input" 
                                   inputmode="latin" 
                                   placeholder="[ENG] ค้นหา... (เช่น: 3*1234.)" 
                                   data-base-placeholder="ค้นหา... (เช่น: 3*1234.)"
                                   autofocus>
                        </div>
                        <div id="search-results"></div>

                        <div id="sales-summary-section" style="margin-top: 1.5rem; display: none;">
                            <h3 id="summary-title">สรุปยอดขาย</h3>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <div class="label">ยอดขายรวม</div>
                                    <div class="value" id="summary-total-sales">0.00</div>
                                </div>
                                <div class="summary-item">
                                    <div class="label">ส่วนลดรวม</div>
                                    <div class="value" id="summary-total-discount" style="color: var(--warning-color);">0.00</div>
                                </div>
                                <div class="summary-item">
                                    <div class="label">ยอดขายสุทธิ</div>
                                    <div class="value" id="summary-net-sales" style="color: var(--success-color);">0.00</div>
                                </div>
                                <div class="summary-item">
                                    <div class="label">กำไร</div>
                                    <div class="value" id="summary-profit" style="color: #00aaff;">0.00</div>
                                </div>
                                <div class="summary-item">
                                    <div class="label">จำนวนบิล</div>
                                    <div class="value" id="summary-bill-count">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="cart-column">
                        <div class="cart-tabs-container">
                            <div id="cart-tabs">
                                <!-- Tabs will be rendered here -->
                            </div>
                        </div>
                        
                        <div id="edit-status" style="display: none; padding: 10px; background-color: #fff3cd; color: #856404; border-radius: 4px; margin-bottom: 1rem; margin-top:1rem;"></div>
                        <div class="cart-header-row">
                            <span class="col-seq">#</span>
                            <span class="col-name">สินค้า</span>
                            <span class="col-qty col-center">จำนวน</span>
                            <span class="col-price col-right">ราคา/หน่วย</span>
                            <span class="col-total col-right">รวม</span>
                            <span class="col-delete col-center">ลบ</span>
                        </div>
                        <ul id="cart-items"></ul>
                        <div class="totals-section">
                            <div class="total-row">
                                <label>ยอดรวม:</label>
                                <span id="cart-subtotal">0.00</span>
                            </div>
                            <div class="total-row">
                                <label for="discount-input">ส่วนลด (บาท):</label>
                                <input type="number" id="discount-input" placeholder="0.00">
                            </div>
                            <div class="total-row" style="font-size: 1.5em; color: var(--success-color);">
                                <label>ยอดสุทธิ:</label>
                                <span id="cart-total">0.00</span>
                            </div>
                        </div>
                        <div class="button-group-2">
                            <button class="finish-sale">ชำระเงิน (F9)</button>
                            <button class="clear-cart">ล้างตะกร้า (F8)</button>
                        </div>
                    </div>
                </div>
            </section>
        
            <section class="card">
                <h2>ประวัติการขาย</h2>
        
                <div class="filter-section" style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap;">
                    <label for="start-date">ตั้งแต่:</label>
                    <input type="date" id="start-date" style="padding: 5px; border-radius: 4px; border: 1px solid var(--border-color);">
                    <input type="time" id="start-time" style="padding: 5px; border-radius: 4px; border: 1px solid var(--border-color);">
                    <label for="end-date">ถึง:</label>
                    <input type="date" id="end-date" style="padding: 5px; border-radius: 4px; border: 1px solid var(--border-color);">
                    <input type="time" id="end-time" style="padding: 5px; border-radius: 4px; border: 1px solid var(--border-color);">
                    <button id="filter-history-btn" style="flex-grow: 0;">ค้นหา</button>
                    <button id="today-history-btn" style="flex-grow: 0; background-color: var(--info-color);">วันนี้</button>
                </div>

                <div class="button-group" style="justify-content: flex-start; margin-bottom: 1rem;">
                    <button id="export-excel-btn" style="flex-grow: 0;">Export to Excel</button>
                    <button id="clear-all-history-btn" class="clear-cart" style="flex-grow: 0; margin-left: auto;">ล้างประวัติทั้งหมด</button>
                </div>
                <div id="history-table-wrapper">
                    <table id="history-table">
                        <thead>
                            <tr><th>วันที่/เวลา</th><th>รหัสการขาย</th><th>รายการสินค้า (จำนวน)</th><th>ส่วนลด</th><th>ยอดรวมสุทธิ</th><th>การกระทำ</th></tr>
                        </thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>
            </section>
        </main>
    
        <!-- Payment Modal -->
        <div id="payment-modal" class="modal-overlay">
            <div class="modal-content">
                <h3>ชำระเงิน</h3>
                <div class="payment-modal-body">
                    <div class="payment-row">
                        <span class="payment-label">ยอดสุทธิที่ต้องชำระ</span>
                        <span class="payment-amount" id="payment-total-final">0.00</span>
                    </div>
                     <div class="payment-row">
                        <label for="cash-received-input" class="payment-label">รับเงินมา</label>
                        <input type="number" id="cash-received-input" step="any" placeholder="0.00">
                    </div>
                     <div class="payment-row">
                        <span class="payment-label">เงินทอน</span>
                        <span class="payment-amount" id="payment-change">0.00</span>
                    </div>
                </div>
                <div class="button-group" style="margin-top: 1.5rem; justify-content: center;">
                    <button id="confirm-sale-btn" class="finish-sale">ยืนยันการขาย (Enter)</button>
                    <button class="clear-cart" id="cancel-payment-btn">ยกเลิก (ESC)</button>
                </div>
            </div>
        </div>
                      
        <!-- Delete Confirmation Modal -->
        <div id="delete-confirm-modal" class="modal-overlay">
            <div class="modal-content">
                <h3>ยืนยันการลบ</h3>
                <p id="delete-confirm-text"></p>
                <div class="button-group" style="justify-content: center;">
                    <button id="confirm-delete-btn" class="clear-cart">ยืนยันการลบ</button>
                    <button id="cancel-delete-btn">ยกเลิก</button>
                </div>
            </div>
        </div>
    
        <!-- Clear Options Modal -->
        <div id="clear-options-modal" class="modal-overlay">
            <div class="modal-content">
                <h3>เลือกวิธีการล้างประวัติ</h3>
                <p>คุณต้องการล้างประวัติการขายแบบใด?</p>
                <div class="button-group" style="flex-direction: column; gap: 1rem;">
                    <button id="clear-local-btn" class="clear-cart" style="background-color: var(--info-color);">ล้างเฉพาะหน้าเว็บนี้</button>
                    <button id="clear-db-btn" class="clear-cart">ล้างจากฐานข้อมูล (ถาวร)</button>
                    <button id="cancel-clear-btn" style="background-color: var(--secondary-color);">ยกเลิก</button>
                </div>
            </div>
        </div>
        
        <!-- Info Modal -->
        <div id="info-modal" class="modal-overlay">
            <div class="modal-content">
                <h3 id="info-modal-title" style="color: var(--primary-color);"></h3>
                <p id="info-modal-text"></p>
                <div class="button-group" style="justify-content: center;">
                    <button id="info-modal-ok-btn">ตกลง (Enter/ESC)</button>
                </div>
            </div>
        </div>

        <!-- Unit Selection Modal -->
        <div id="unit-selection-modal" class="modal-overlay">
            <div class="modal-content">
                <h3 id="unit-modal-title">กรุณาเลือกหน่วยสินค้า</h3>
                <div id="unit-options-container" style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Unit options will be injected here by JavaScript -->
                </div>
                <div class="button-group" style="margin-top: 1.5rem; justify-content: center;">
                    <button id="cancel-unit-selection-btn" style="background-color: var(--secondary-color);">ยกเลิก (ESC)</button>
                </div>
            </div>
        </div>
    
    </div>

    <script type="module">
        // Import necessary functions from Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, writeBatch, getDocs, query, where, setDoc, updateDoc, collectionGroup, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE INITIALIZATION ---
        // === START: UPDATED FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyDOx9RPxrG-vO59QHjkhJtGmyDRhdoVFPY",
            authDomain: "pos-6-23035.firebaseapp.com",
            projectId: "pos-6-23035",
            storageBucket: "pos-6-23035.firebasestorage.app",
            messagingSenderId: "1025982856125",
            appId: "1:1025982856125:web:8c6cdf5712e44abe0f30d4"
        };
        // === END: UPDATED FIREBASE CONFIG ===

        try {
            const appId = firebaseConfig.projectId;

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            setLogLevel('debug');

            // --- AUTHENTICATION ---
            await signInAnonymously(auth);
            console.log("Signed in anonymously.");
            
            // Expose Firebase services to the main application script via the window object
            window.firebaseServices = {
                db,
                auth,
                appId,
                api: {
                    collection, onSnapshot, addDoc, doc, deleteDoc, writeBatch, 
                    getDocs, query, where, setDoc, updateDoc, collectionGroup
                }
            };

        } catch (error) {
            console.error("Firebase Initialization Failed:", error);
            window.firebaseFailed = true;
            window.firebaseError = error.message;
        } finally {
            window.firebaseReady = true;
        }
    </script>

    <script>
    // ===================================================================================
    // --- POS APPLICATION LOGIC (Encapsulated & Online) ---
    // ===================================================================================
    const POS_APP = {
        // --- CONFIGURATION & STATE ---
        config: {
            googleSheetUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTT3t_8Hx7WcD8uUi2IGt1zDbOMB3MSK57dYnfqrrut3do_Gw2hzYSG9IBIEg8fg7uTEL2sVq-IfVJR/pub?gid=0&single=true&output=csv',
            thaiToEngMap: { 'ๅ': '1', '/': '2', '-': '3', 'ภ': '4', 'ถ': '5', 'ุ': '6', 'ึ': '7', 'ค': '8', 'ต': '9', 'จ': '0', 'ข': '-', 'ช': '=', 'ๆ': 'q', 'ไ': 'w', 'ำ': 'e', 'พ': 'r', 'ะ': 't', 'ั': 'y', 'ี': 'u', 'ร': 'i', 'น': 'o', 'ย': 'p', 'บ': '[', 'ล': ']', 'ฟ': 'a', 'ห': 's', 'ก': 'd', 'ด': 'f', 'เ': 'g', '้': 'h', '่': 'j', 'า': 'k', 'ส': 'l', 'ว': ';', 'ง': "'", 'ผ': 'z', 'ป': 'x', 'แ': 'c', 'อ': 'v', 'ิ': 'b', 'ท': 'n', 'ม': 'm', 'ใ': ',', 'ฝ': '.', 'ซ': '/' }
        },
        state: {
            productDatabase: [],
            salesHistory: [],
            currentSearchResults: [],
            selectedSearchIndex: -1,
            unsubscribeSalesHistory: null,
            isSaving: false,
            activeModalCloseHandler: null,
            tabs: new Map(),
            activeTabId: null,
            isRestrictedMode: true,
            keyboardLayout: 'ENG',
            basePlaceholder: 'ค้นหา...'
        },

        // --- INITIALIZATION ---
        init() {
            const firebaseCheckInterval = setInterval(() => {
                if (window.firebaseReady) {
                    clearInterval(firebaseCheckInterval);
                    if (window.firebaseFailed) {
                        this.showInfoModal("ข้อผิดพลาดร้ายแรง", `ไม่สามารถเชื่อมต่อฐานข้อมูลได้: ${window.firebaseError}`, true);
                        return;
                    }
                    this.start();
                }
            }, 100);
        },
        
        start() {
            console.log("Initializing main application logic...");
            const barcodeInput = document.getElementById('barcode-input');
            if (barcodeInput) {
                this.state.basePlaceholder = barcodeInput.getAttribute('data-base-placeholder');
            }
            this.updatePlaceholderHint();
            this.clearDataOnStart();
            this.filterHistoryForToday();
            if (this.state.tabs.size === 0) {
                this.addNewSaleTab();
            }
            this.loadProductData();
            this.setupEventListeners();
            this.toggleUIVisibility(); 
            document.getElementById('barcode-input').focus();
        },
        
        clearDataOnStart() {
            this.state.salesHistory = [];
            this.state.tabs = new Map();
            this.state.activeTabId = null;
            if (this.state.unsubscribeSalesHistory) {
                this.state.unsubscribeSalesHistory();
                this.state.unsubscribeSalesHistory = null;
            }
            this.updateHistoryDisplay();
            this.calculateSummaryForDisplayedHistory();
            this.renderTabs();
            const cartItemsEl = document.getElementById('cart-items');
            if (cartItemsEl) cartItemsEl.innerHTML = '';
            this.updateCartDisplay();
        },

        setupEventListeners() {
            const barcodeInput = document.getElementById('barcode-input');
            barcodeInput.addEventListener('input', this.handleInstantSearch.bind(this));
            barcodeInput.addEventListener('keydown', this.handleSearchKeyDown.bind(this));
            barcodeInput.addEventListener('keydown', this.detectKeyboardLayout.bind(this));

            document.getElementById('discount-input').addEventListener('input', this.updateCartOnInput.bind(this));
            document.getElementById('discount-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.showPaymentModal();
                }
            });

            document.querySelector('.finish-sale').addEventListener('click', this.showPaymentModal.bind(this));
            document.querySelector('.clear-cart').addEventListener('click', this.showClearCartConfirmModal.bind(this));
            
            document.getElementById('filter-history-btn').addEventListener('click', this.filterHistoryByDateTime.bind(this));
            document.getElementById('today-history-btn').addEventListener('click', this.filterHistoryForToday.bind(this));
            document.getElementById('export-excel-btn').addEventListener('click', this.exportToExcel.bind(this));
            document.getElementById('clear-all-history-btn').addEventListener('click', this.showClearOptionsModal.bind(this));
            
            document.getElementById('cash-received-input').addEventListener('input', this.calculateChange.bind(this));
            document.getElementById('cash-received-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.calculateChange();
                    document.getElementById('confirm-sale-btn').focus();
                }
            });
            document.getElementById('confirm-sale-btn').addEventListener('click', this.confirmSale.bind(this));
            document.getElementById('cancel-payment-btn').addEventListener('click', this.hidePaymentModal.bind(this));
            
            document.getElementById('cancel-delete-btn').addEventListener('click', this.hideDeleteConfirmModal.bind(this));
            
            document.getElementById('clear-local-btn').addEventListener('click', this.clearHistoryLocally.bind(this));
            document.getElementById('clear-db-btn').addEventListener('click', this.executeClearAllHistory.bind(this));
            document.getElementById('cancel-clear-btn').addEventListener('click', this.hideClearOptionsModal.bind(this));
            
            document.getElementById('info-modal-ok-btn').addEventListener('click', this.hideInfoModal.bind(this));
            
            document.addEventListener('keydown', this.handleGlobalKeyDown.bind(this));
        },
        
        // --- FIRESTORE HELPERS ---
        getSalesHistoryCollectionRef() {
            const { appId, db, api } = window.firebaseServices;
            if (!appId) {
                console.error("App ID not available for Firestore query.");
                return null;
            }
            return api.collection(db, `artifacts/${appId}/public/data/salesHistory`);
        },

        getSalesHistoryDocRef(firestoreId) {
            const { appId, db, api } = window.firebaseServices;
            if (!appId || !firestoreId) {
                console.error("App ID or Document ID not available for Firestore query.");
                return null;
            }
            return api.doc(db, `artifacts/${appId}/public/data/salesHistory`, firestoreId);
        },
        
        // --- MODAL & NOTIFICATION SYSTEM ---
        showInfoModal(title, text, isError = false) {
            const titleEl = document.getElementById('info-modal-title');
            const textEl = document.getElementById('info-modal-text');
            const okBtn = document.getElementById('info-modal-ok-btn');
            
            titleEl.textContent = title;
            titleEl.style.color = isError ? 'var(--danger-color)' : 'var(--primary-color)';
            textEl.textContent = text;
            okBtn.style.backgroundColor = isError ? 'var(--danger-color)' : 'var(--primary-color)';
            
            document.getElementById('info-modal').style.display = 'flex';

            this.state.activeModalCloseHandler = (e) => {
                if (e.key === 'Enter' || e.key === 'Escape') {
                    e.preventDefault();
                    this.hideInfoModal();
                }
            };
            document.addEventListener('keydown', this.state.activeModalCloseHandler);
            okBtn.focus();
        },

        hideInfoModal() {
            document.getElementById('info-modal').style.display = 'none';
            if (this.state.activeModalCloseHandler) {
                document.removeEventListener('keydown', this.state.activeModalCloseHandler);
                this.state.activeModalCloseHandler = null;
            }
        },

        // --- KEYBOARD HANDLING ---
        updatePlaceholderHint() {
            const input = document.getElementById('barcode-input');
            if (input) {
                input.placeholder = `[${this.state.keyboardLayout}] ${this.state.basePlaceholder}`;
            }
        },

        detectKeyboardLayout(e) {
            if (e.key.length !== 1 || e.ctrlKey || e.altKey || e.metaKey) {
                return;
            }
            const isThai = /[ก-๙]/.test(e.key);
            if (isThai && this.state.keyboardLayout !== 'TH') {
                this.state.keyboardLayout = 'TH';
                this.updatePlaceholderHint();
            } else if (!isThai && this.state.keyboardLayout !== 'ENG') {
                this.state.keyboardLayout = 'ENG';
                this.updatePlaceholderHint();
            }
        },
        
        handleCartItemKeyDown(e, type, index) {
            if (e.key !== 'Enter') return;

            e.preventDefault();
            e.target.blur(); 

            setTimeout(() => {
                const rowElement = e.target.closest('li');
                if (!rowElement) return;

                if (type === 'qty') {
                    const nextInput = rowElement.querySelector(`#price-input-${index}`);
                    if (nextInput) {
                        nextInput.focus();
                        nextInput.select();
                    }
                } else if (type === 'price') {
                    const nextInput = rowElement.querySelector(`#total-input-${index}`);
                    if (nextInput) {
                        nextInput.focus();
                        nextInput.select();
                    }
                } else if (type === 'total') {
                    const discountInput = document.getElementById('discount-input');
                    if (discountInput) {
                        discountInput.focus();
                        discountInput.select();
                    }
                }
            }, 50);
        },

        handleSearchKeyDown(e) {
            if (e.key === 'Enter') { 
                e.preventDefault();
                const inputValue = document.getElementById('barcode-input').value.trim();

                if (inputValue === '0000000000') {
                    this.state.isRestrictedMode = true;
                    this.toggleUIVisibility();
                    document.getElementById('barcode-input').value = '';
                    this.displaySearchResults([]);
                    return;
                } else if (inputValue === '1111111111') {
                    this.state.isRestrictedMode = false;
                    this.toggleUIVisibility();
                    document.getElementById('barcode-input').value = '';
                    this.displaySearchResults([]);
                    return;
                }

                const quantityPattern = /^(\d+)\s*\*\s*(.+)$/;
                const match = inputValue.match(quantityPattern);

                if (this.state.currentSearchResults.length > 0 && this.state.selectedSearchIndex !== -1) {
                    let quantityToAdd = match ? parseInt(match[1], 10) : 1;
                    
                    const product = this.state.currentSearchResults[this.state.selectedSearchIndex];
                    if (product.pricing_units && product.pricing_units.length > 0) {
                        this.showUnitSelectionModal(product, quantityToAdd);
                    } else {
                        this.addToCart(product, quantityToAdd);
                    }
                    
                    document.getElementById('barcode-input').value = '';
                    this.state.currentSearchResults = []; 
                    this.state.selectedSearchIndex = -1; 
                    this.displaySearchResults([]);
                } else if (this.getActiveCart().length > 0 && inputValue === '') {
                    document.getElementById('discount-input').focus();
                    document.getElementById('discount-input').select();
                }
            } 
            else if (e.key === 'ArrowDown') { e.preventDefault(); this.navigateSearchResults(1); } 
            else if (e.key === 'ArrowUp') { e.preventDefault(); this.navigateSearchResults(-1); }
        },
        handleGlobalKeyDown(e) { 
            if (this.state.activeModalCloseHandler) return;

            if (e.ctrlKey && (e.key === 'Tab' || e.key === 'ArrowRight' || e.key === 'ArrowLeft')) {
                e.preventDefault();
                const direction = (e.shiftKey || e.key === 'ArrowLeft') ? -1 : 1;
                this.navigateTabs(direction);
            }
            else if (e.ctrlKey && e.key === 'w') {
                e.preventDefault();
                if(this.state.activeTabId) this.closeTab(this.state.activeTabId);
            }
            else if (e.key === 'Delete') {
                e.preventDefault();
                if(this.state.activeTabId) this.closeTab(this.state.activeTabId, true); 
            }
            else if (e.key === 'F9') { e.preventDefault(); this.showPaymentModal(); } 
            else if (e.key === 'F5') { e.preventDefault(); document.getElementById('barcode-input').focus(); } 
            else if (e.key === 'F11') { e.preventDefault(); document.getElementById('discount-input').focus(); document.getElementById('discount-input').select(); }
            else if (e.key === 'F2') { e.preventDefault(); this.addNewSaleTab(); }
            else if (e.key === 'F8') { e.preventDefault(); this.showClearCartConfirmModal(); }
            else if (e.key === 'Escape') {
                if (document.getElementById('payment-modal').style.display === 'flex') { e.preventDefault(); this.hidePaymentModal(); }
                if (document.getElementById('delete-confirm-modal').style.display === 'flex') { e.preventDefault(); this.hideDeleteConfirmModal(); }
                if (document.getElementById('clear-options-modal').style.display === 'flex') { e.preventDefault(); this.hideClearOptionsModal(); }
                if (document.getElementById('unit-selection-modal').style.display === 'flex') { e.preventDefault(); this.hideUnitSelectionModal(); }
            }
        },

        navigateSearchResults(direction) {
            if (this.state.currentSearchResults.length === 0) return;
            this.state.selectedSearchIndex += direction;
            if (this.state.selectedSearchIndex < 0) this.state.selectedSearchIndex = this.state.currentSearchResults.length - 1;
            else if (this.state.selectedSearchIndex >= this.state.currentSearchResults.length) this.state.selectedSearchIndex = 0;
            this.updateSelectedSearchResult();
        },
        
        updateSelectedSearchResult() {
            const items = document.querySelectorAll('.search-item');
            items.forEach((item, index) => {
                if (index === this.state.selectedSearchIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        },

        // --- DATA LOADING & SAVING ---
        loadProductData() {
            if (this.state.productDatabase.length > 0) {
                console.log("Product data already loaded.");
                return;
            }
            Papa.parse(this.config.googleSheetUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    console.log("Parsed CSV Headers:", results.meta.fields);
                    const rawData = results.data;
                    const cleanDatabase = [];

                    rawData.forEach(p => {
                        const productCode = p['รหัสสินค้า'] ? p['รหัสสินค้า'].toString().trim() : '';
                        if (productCode) {
                            const cleanProduct = {
                                code: productCode,
                                name: p['ชื่อการค้า'] || 'N/A',
                                unit: p['หน่วย'] || '',
                                barcode: p['บาร์โค้ด'] || '',
                                price: parseFloat(p['ราคา']) || 0,
                                stock: parseInt(p['คงเหลือ'], 10) || 0,
                                cost: parseFloat(p['ต้นทุน']) || 0,
                                pricing_units: [],
                                pricing_tiers: []
                            };

                            // --- NEW DEDICATED COLUMN LOGIC ---
                            for (let i = 1; i <= 5; i++) {
                                if (p[`unit${i}`] && p[`price${i}`]) {
                                    cleanProduct.pricing_units.push({
                                        unit: p[`unit${i}`],
                                        price: parseFloat(p[`price${i}`]),
                                        barcode: p[`barcode${i}`] || ''
                                    });
                                }
                            }

                            for (let i = 1; i <= 5; i++) {
                                if (p[`min_qty${i}`] && p[`price_tier${i}`]) {
                                    cleanProduct.pricing_tiers.push({
                                        min_qty: parseInt(p[`min_qty${i}`], 10),
                                        price_per_unit: parseFloat(p[`price_tier${i}`])
                                    });
                                }
                            }
                            // --- END: NEW DEDICATED COLUMN LOGIC ---

                            cleanProduct._searchableText = [
                                cleanProduct.name,
                                cleanProduct.code,
                                cleanProduct.barcode,
                                cleanProduct.price.toString()
                            ].join(' ').toLowerCase();
                            
                            if (cleanProduct.pricing_units.length > 0) {
                                cleanProduct.pricing_units.forEach(unit => {
                                    if (unit.barcode) {
                                        cleanProduct._searchableText += ' ' + unit.barcode;
                                    }
                                });
                            }
                            
                            cleanDatabase.push(cleanProduct);
                        }
                    });
                    
                    this.state.productDatabase = cleanDatabase;
                    console.log("Product database loaded and processed:", this.state.productDatabase);
                },
                error: (error, file) => {
                    console.error('Error parsing product data with PapaParse:', error, file);
                    this.showInfoModal('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการโหลดข้อมูลสินค้าจาก Google Sheet', true);
                }
            });
        },

        // --- SEARCH LOGIC ---
        translateThaiToEng(input) { return input.split('').map(char => this.config.thaiToEngMap[char] || char).join(''); },

        handleInstantSearch(e) {
            const query = e.target.value.toLowerCase().trim();
            const quantityPattern = /^(\d+)\s*\*\s*(.+)$/;
            const match = query.match(quantityPattern);
            let effectiveQuery = match ? match[2].trim() : query;

            if (effectiveQuery.length < 1) {
                this.state.currentSearchResults = []; this.state.selectedSearchIndex = -1; this.displaySearchResults([]);
                return;
            }

            const translatedQuery = this.translateThaiToEng(effectiveQuery);
            const queryTerms = effectiveQuery.split(' ').filter(term => term.length > 0);
            const translatedQueryTerms = translatedQuery.split(' ').filter(term => term.length > 0);

            this.state.currentSearchResults = this.state.productDatabase.filter(p => {
                const allTermsMatch = queryTerms.every(term => p._searchableText.includes(term));
                const allTranslatedTermsMatch = translatedQueryTerms.every(term => p._searchableText.includes(term));
                return allTermsMatch || allTranslatedTermsMatch;
            });

            this.state.selectedSearchIndex = this.state.currentSearchResults.length > 0 ? 0 : -1;
            this.displaySearchResults(this.state.currentSearchResults);
        },
        
        displaySearchResults(results) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';

            if (results.length > 0) {
                resultsContainer.classList.add('has-results');
            } else {
                resultsContainer.classList.remove('has-results');
            }
            
            if (results.length === 0) return;
            
            const self = this;

            results.forEach((product, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'search-item';
                if (index === this.state.selectedSearchIndex) itemDiv.classList.add('selected');
                
                itemDiv.innerHTML = `
                    <div>
                        <span>${product.name}</span>
                    </div>
                    <span class="price" style="color:var(--success-color); font-weight:bold;">${parseFloat(product.price).toFixed(2)} ฿</span>`;
                
                itemDiv.onclick = () => {
                    const inputValue = document.getElementById('barcode-input').value.trim();
                    const quantityPattern = /^(\d+)\s*\*\s*(.+)$/;
                    const match = inputValue.match(quantityPattern);
                    let quantityToAdd = match ? parseInt(match[1], 10) : 1;
                    
                    if (product.pricing_units && product.pricing_units.length > 0) {
                        self.showUnitSelectionModal(product, quantityToAdd);
                    } else {
                        self.addToCart(product, quantityToAdd);
                    }

                    document.getElementById('barcode-input').value = '';
                    self.state.currentSearchResults = []; self.state.selectedSearchIndex = -1; self.displaySearchResults([]);
                };
                resultsContainer.appendChild(itemDiv);
            });
        },
        
        // --- UNIT SELECTION MODAL LOGIC ---
        showUnitSelectionModal(product, quantity) {
            const modal = document.getElementById('unit-selection-modal');
            const titleEl = document.getElementById('unit-modal-title');
            const optionsContainer = document.getElementById('unit-options-container');

            titleEl.textContent = `เลือกหน่วยสำหรับ: ${product.name}`;
            optionsContainer.innerHTML = '';

            product.pricing_units.forEach(unit => {
                const unitButton = document.createElement('button');
                unitButton.textContent = `${unit.unit} - ราคา ${unit.price.toFixed(2)} บาท`;
                unitButton.onclick = () => {
                    const selectedUnitProduct = {
                        ...product,
                        price: unit.price,
                        unit: unit.unit,
                        code: unit.barcode || product.code 
                    };
                    this.addToCart(selectedUnitProduct, quantity);
                    this.hideUnitSelectionModal();
                };
                optionsContainer.appendChild(unitButton);
            });

            modal.style.display = 'flex';
            
            this.state.activeModalCloseHandler = (e) => {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    this.hideUnitSelectionModal();
                }
            };
            document.addEventListener('keydown', this.state.activeModalCloseHandler);
            document.getElementById('cancel-unit-selection-btn').onclick = () => this.hideUnitSelectionModal();
        },

        hideUnitSelectionModal() {
            document.getElementById('unit-selection-modal').style.display = 'none';
            if (this.state.activeModalCloseHandler) {
                document.removeEventListener('keydown', this.state.activeModalCloseHandler);
                this.state.activeModalCloseHandler = null;
            }
            document.getElementById('barcode-input').focus();
        },

        // --- CART & TAB LOGIC ---
        getActiveCart() {
            if (!this.state.activeTabId || !this.state.tabs.has(this.state.activeTabId)) return [];
            return this.state.tabs.get(this.state.activeTabId).cart;
        },

        getActiveDiscount() {
            if (!this.state.activeTabId || !this.state.tabs.has(this.state.activeTabId)) return 0;
            return this.state.tabs.get(this.state.activeTabId).discount;
        },

        setActiveDiscount(value) {
            if (this.state.activeTabId && this.state.tabs.has(this.state.activeTabId)) {
                this.state.tabs.get(this.state.activeTabId).discount = value;
            }
        },

        addToCart(product, quantityToAdd = 1) {
            const cart = this.getActiveCart();
            if (!cart) return;

            const existingProduct = cart.find(item => item.code === product.code);
            
            if (existingProduct) {
                existingProduct.quantity += quantityToAdd;
            } else {
                const newCartItem = { ...product, quantity: quantityToAdd, base_price: product.price };
                cart.push(newCartItem);
            }
            
            this.updateCartDisplay();
        },
        
        deleteItemFromCart(index) {
            const cart = this.getActiveCart();
            cart.splice(index, 1);
            this.updateCartDisplay();
        },

        editItemQuantity(index, newQuantityString) {
            const cart = this.getActiveCart();
            const newQuantity = parseInt(newQuantityString, 10);
            if (isNaN(newQuantity) || newQuantity <= 0) {
                cart.splice(index, 1);
            } else {
                const item = cart[index];
                if (item) {
                    item.quantity = newQuantity;
                }
            }
            this.updateCartDisplay();
        },

        editItemPrice(index, newPriceString) {
            const cart = this.getActiveCart();
            const newPrice = parseFloat(newPriceString);
            if (!isNaN(newPrice) && newPrice >= 0) {
                const item = cart[index];
                if (item) {
                    item.price = newPrice;
                    item.base_price = newPrice; // Update base price as well on manual edit
                }
            }
            this.updateCartDisplay();
        },
        
        editItemTotalPrice(index, newTotalString) {
            const cart = this.getActiveCart();
            const newTotal = parseFloat(newTotalString);
            if (!isNaN(newTotal) && newTotal >= 0) {
                const item = cart[index];
                if (item && item.quantity > 0) {
                    const newPrice = newTotal / item.quantity;
                    item.price = newPrice;
                    item.base_price = newPrice; // Update base price as well
                }
            }
            this.updateCartDisplay();
        },

        updateCartDisplay() {
            const cart = this.getActiveCart();
            const discount = this.getActiveDiscount();
            const discountInput = document.getElementById('discount-input');
            if (discountInput) {
                discountInput.value = discount || '';
            }

            const cartItemsElement = document.getElementById('cart-items');
            if (cartItemsElement) cartItemsElement.innerHTML = '';
            
            if(!cart) return;

            // Tiered Pricing Logic
            cart.forEach(item => {
                let effectivePrice = item.base_price || item.price;
                if (item.pricing_tiers && item.pricing_tiers.length > 0) {
                    const sortedTiers = [...item.pricing_tiers].sort((a, b) => b.min_qty - a.min_qty);
                    for (const tier of sortedTiers) {
                        if (item.quantity >= tier.min_qty) {
                            effectivePrice = tier.price_per_unit;
                            break;
                        }
                    }
                }
                item.price = effectivePrice; 
            });

            const subtotal = cart.reduce((sum, item) => sum + (item.price || 0) * item.quantity, 0);
            const total = subtotal - (discount || 0);
            
            cart.forEach((item, index) => {
                const li = document.createElement('li');
                
                let itemInfoHTML = `<strong>${item.name}</strong>`;
                if (item.unit) {
                    itemInfoHTML += ` <span class="sub-text">(${item.unit})</span>`;
                }
                if (!this.state.isRestrictedMode) {
                     itemInfoHTML += ` <span class="sub-text">(คงเหลือ: ${item.stock || 0})(ต้นทุน: ${(item.cost || 0).toFixed(2)})</span>`;
                }

                li.innerHTML = `
                    <div class="col-seq">${index + 1}.</div>
                    <div class="col-name">${itemInfoHTML}</div>
                    <div class="col-qty">
                        <input type="text" inputmode="numeric" class="item-input" id="qty-input-${index}" value="${item.quantity}" onchange="POS_APP.editItemQuantity(${index}, this.value)" onfocus="this.select()" onkeydown="POS_APP.handleCartItemKeyDown(event, 'qty', ${index})">
                    </div>
                    <div class="col-price col-right">
                         <input type="text" inputmode="decimal" class="item-input" id="price-input-${index}" value="${parseFloat(item.price).toFixed(2)}" onchange="POS_APP.editItemPrice(${index}, this.value)" onfocus="this.select()" onkeydown="POS_APP.handleCartItemKeyDown(event, 'price', ${index})">
                    </div>
                    <div class="col-total col-right">
                        <input type="text" inputmode="decimal" class="item-input" id="total-input-${index}" value="${((item.price || 0) * item.quantity).toFixed(2)}" onchange="POS_APP.editItemTotalPrice(${index}, this.value)" onfocus="this.select()" onkeydown="POS_APP.handleCartItemKeyDown(event, 'total', ${index})">
                    </div>
                    <div class="col-delete col-center">
                        <button class="delete-item-btn" onclick="POS_APP.deleteItemFromCart(${index})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                        </button>
                    </div>
                `;
                if (cartItemsElement) cartItemsElement.appendChild(li);
            });

            const cartSubtotal = document.getElementById('cart-subtotal');
            const cartTotal = document.getElementById('cart-total');
            if (cartSubtotal) cartSubtotal.textContent = subtotal.toFixed(2);
            if (cartTotal) cartTotal.textContent = total.toFixed(2);
        },
        updateCartOnInput(){
            const discountValue = parseFloat(document.getElementById('discount-input').value) || 0;
            this.setActiveDiscount(discountValue);
            this.updateCartDisplay();
        },

        clearCart() {
            const tabData = this.state.tabs.get(this.state.activeTabId);
            if (tabData && tabData.cart.length > 0) {
                tabData.cart = [];
                tabData.discount = 0;
                this.updateCartDisplay();
            }
        },

        showClearCartConfirmModal() {
            const cart = this.getActiveCart();
            if (cart.length === 0) return;

            const confirmBtn = document.getElementById('confirm-delete-btn');
            const confirmText = document.getElementById('delete-confirm-text');
            
            confirmText.textContent = `คุณแน่ใจหรือไม่ว่าต้องการล้างตะกร้าสินค้าทั้งหมด?`;
            confirmBtn.onclick = () => {
                this.clearCart();
                this.hideDeleteConfirmModal();
            };
            
            document.getElementById('delete-confirm-modal').style.display = 'flex';
            confirmBtn.focus();
        },

        // --- PAYMENT & SUCCESS MODAL LOGIC ---
        showPaymentModal() {
            const cart = this.getActiveCart();
            if (cart.length === 0) return;
            const subtotal = cart.reduce((sum, item) => sum + (item.price || 0) * item.quantity, 0);
            const discount = this.getActiveDiscount();
            const finalTotal = subtotal - discount;

            document.getElementById('payment-total-final').textContent = finalTotal.toFixed(2);
            document.getElementById('payment-change').textContent = "0.00";
            
            const cashInput = document.getElementById('cash-received-input');
            cashInput.value = '';
            document.getElementById('payment-modal').style.display = 'flex';
            cashInput.focus();
        },
        hidePaymentModal() { 
            document.getElementById('payment-modal').style.display = 'none'; 
            document.getElementById('barcode-input').focus();
        },
        calculateChange() {
            const total = parseFloat(document.getElementById('payment-total-final').textContent);
            const cashReceived = parseFloat(document.getElementById('cash-received-input').value) || 0;
            const change = cashReceived - total;
            const changeEl = document.getElementById('payment-change');
            if (change >= 0) {
                changeEl.textContent = change.toFixed(2);
                changeEl.style.color = 'var(--success-color)';
            } else {
                changeEl.textContent = 'เงินไม่พอ';
                changeEl.style.color = 'var(--danger-color)';
            }
        },
        
        // --- SALE & HISTORY LOGIC (with Firestore) ---
        async confirmSale() {
            if (this.state.isSaving) return; 
            
            const collectionRef = this.getSalesHistoryCollectionRef();
            if (!collectionRef) {
                this.showInfoModal("ข้อผิดพลาด", "ยังไม่ได้เชื่อมต่อกับฐานข้อมูล กรุณารอสักครู่แล้วลองอีกครั้ง", true);
                return;
            }
            
            const cart = this.getActiveCart();
            const discount = this.getActiveDiscount();
            const subtotal = cart.reduce((sum, item) => sum + (item.price || 0) * item.quantity, 0);
            const finalTotal = subtotal - discount;
            const cashReceived = parseFloat(document.getElementById('cash-received-input').value) || 0;

            if (cashReceived < finalTotal) {
                this.showInfoModal("ข้อผิดพลาด", "จำนวนเงินที่รับมาไม่เพียงพอ", true);
                return;
            }
            
            this.state.isSaving = true;
            const confirmButton = document.getElementById('confirm-sale-btn');
            confirmButton.disabled = true;

            const newSaleId = await this.generateSaleId();

            const saleRecord = {
                id: newSaleId,
                timestamp: new Date().toISOString(),
                items: JSON.parse(JSON.stringify(cart)), 
                subtotal: subtotal,
                discount: discount,
                total: finalTotal,
                cashReceived: cashReceived,
                change: cashReceived - finalTotal,
            };
            
            try {
                await window.firebaseServices.api.addDoc(collectionRef, saleRecord);
                console.log("Sale recorded to Firestore with ID:", newSaleId);
                
                const tabToDelete = this.state.activeTabId;
                
                document.getElementById('edit-status').style.display = 'none';
                this.hidePaymentModal(); 
                
                this.closeTab(tabToDelete, false); 

            } catch (e) {
                console.error("Error adding document: ", e);
                this.showInfoModal("ข้อผิดพลาด", "เกิดข้อผิดพลาดในการบันทึกข้อมูลการขาย!", true);
            } finally {
                this.state.isSaving = false;
                confirmButton.disabled = false;
            }
        },
        
        async editSaleRecord(firestoreId) {
            const docRef = this.getSalesHistoryDocRef(firestoreId);
            if (!docRef) {
                this.showInfoModal("ข้อผิดพลาด", "ยังไม่ได้เชื่อมต่อกับฐานข้อมูล กรุณารอสักครู่แล้วลองอีกครั้ง", true);
                return;
            }
            const saleToEdit = this.state.salesHistory.find(sale => sale.firestoreId === firestoreId);
            if (!saleToEdit) {
                console.error("Sale to edit not found in local cache:", firestoreId);
                return;
            }
            
            const newTabId = 'edit-' + Date.now();
            this.state.tabs.set(newTabId, {
                cart: JSON.parse(JSON.stringify(saleToEdit.items)),
                discount: saleToEdit.discount || 0,
                name: `แก้ไข: ${saleToEdit.id}`,
                isEditing: true,
                originalFirestoreId: firestoreId
            });

            try {
                await window.firebaseServices.api.deleteDoc(docRef);
                console.log("Moved sale record to an editing tab:", firestoreId);
            } catch(e) {
                console.error("Error deleting document for edit: ", e);
                this.showInfoModal("ข้อผิดพลาด", "เกิดข้อผิดพลาดในการย้ายข้อมูลเพื่อแก้ไข!", true);
                this.state.tabs.delete(newTabId); 
                return; 
            }

            this.renderTabs();
            this.switchTab(newTabId);
            
            const statusDiv = document.getElementById('edit-status');
            statusDiv.textContent = `กำลังแก้ไขรายการขาย ${saleToEdit.id}. เพิ่ม/ลบสินค้า แล้วกด "ชำระเงิน" เพื่อบันทึกใหม่`;
            statusDiv.style.display = 'block';
            document.getElementById('barcode-input').focus();
        },

        showDeleteConfirmModal(id, isTab) {
            const confirmBtn = document.getElementById('confirm-delete-btn');
            const confirmText = document.getElementById('delete-confirm-text');

            if (isTab) {
                 const tabData = this.state.tabs.get(id);
                 confirmText.textContent = `คุณแน่ใจหรือไม่ว่าต้องการปิดบิล '${tabData.name}'?`;
                 confirmBtn.onclick = () => {
                     this.closeTab(id, false);
                     this.hideDeleteConfirmModal();
                 };
            } else { // It's a history item, id is the firestoreId
                 const sale = this.state.salesHistory.find(s => s.firestoreId === id);
                 confirmText.textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบรายการขาย ID: ${sale ? sale.id : id}? การกระทำนี้ไม่สามารถย้อนกลับได้`;
                 confirmBtn.onclick = () => this.executeDeleteSaleFromHistory(id);
            }
            
            document.getElementById('delete-confirm-modal').style.display = 'flex';
            setTimeout(() => confirmBtn.focus(), 50);
        },

        hideDeleteConfirmModal() {
            document.getElementById('delete-confirm-modal').style.display = 'none';
        },

        async executeDeleteSaleFromHistory(firestoreId) {
            const docRef = this.getSalesHistoryDocRef(firestoreId);
            this.hideDeleteConfirmModal(); 
            if (!docRef) {
                this.showInfoModal("ข้อผิดพลาด", "ยังไม่ได้เชื่อมต่อกับฐานข้อมูล กรุณารอสักครู่แล้วลองอีกครั้ง", true);
                return;
            }
            try {
                await window.firebaseServices.api.deleteDoc(docRef);
                console.log("Deleted sale record:", firestoreId);
            } catch (e) {
                console.error("Error deleting document: ", e);
                this.showInfoModal("ข้อผิดพลาด", "เกิดข้อผิดพลาดในการลบข้อมูล!", true);
            }
        },

        showClearOptionsModal() {
            document.getElementById('clear-options-modal').style.display = 'flex';
        },

        hideClearOptionsModal() {
            document.getElementById('clear-options-modal').style.display = 'none';
            document.getElementById('barcode-input').focus();
        },

        clearHistoryLocally() {
            this.state.salesHistory = [];
            this.updateHistoryDisplay();
            this.calculateSummaryForDisplayedHistory();
            this.hideClearOptionsModal();
            console.log("History cleared locally from the display.");
        },

        async executeClearAllHistory() {
            this.hideClearOptionsModal();
            const salesCollection = this.getSalesHistoryCollectionRef();
            if (!salesCollection) {
                this.showInfoModal("ข้อผิดพลาด", "ยังไม่ได้เชื่อมต่อกับฐานข้อมูล กรุณารอสักครู่แล้วลองอีกครั้ง", true);
                return;
            }
            try {
                const querySnapshot = await window.firebaseServices.api.getDocs(salesCollection);
                const batch = window.firebaseServices.api.writeBatch(window.firebaseServices.db);
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                console.log("All sales history cleared from Firestore.");
            } catch (e) {
                console.error("Error clearing history: ", e);
                this.showInfoModal("ข้อผิดพลาด", "เกิดข้อผิดพลาดในการล้างประวัติทั้งหมด!", true);
            }
        },

        updateHistoryDisplay() {
            const historyBody = document.getElementById('history-body');
            const clearHistoryBtn = document.getElementById('clear-all-history-btn');
            
            if (!historyBody) return;
            historyBody.innerHTML = '';

            const now = new Date();
            const startOfCurrentHour = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours());
            
            if (this.state.salesHistory.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">ไม่พบประวัติการขาย</td></tr>';
                if(clearHistoryBtn) clearHistoryBtn.disabled = true;
                return;
            }
            if(clearHistoryBtn) clearHistoryBtn.disabled = false;
            
            this.state.salesHistory.forEach((sale) => {
                const row = historyBody.insertRow();

                const saleTimestamp = new Date(sale.timestamp);
                if (saleTimestamp < startOfCurrentHour) {
                    row.classList.add('exported-row');
                    row.title = 'รายการนี้ถูก Export แล้วโดยระบบอัตโนมัติ';
                }

                const itemDetails = sale.items.map(item => `${item.name} (${item.unit || ''} x${item.quantity})`).join('<br>');
                const discountAmount = sale.discount ? sale.discount.toFixed(2) : '0.00';
                
                let actionCellHTML = '';
                if (!this.state.isRestrictedMode) {
                    actionCellHTML = `<button class="edit-history-btn" onclick="POS_APP.editSaleRecord('${sale.firestoreId}')">แก้ไข</button><button class="delete-history-btn" onclick="POS_APP.showDeleteConfirmModal('${sale.firestoreId}', false)">ลบ</button>`;
                }

                row.innerHTML = `<td>${new Date(sale.timestamp).toLocaleString('th-TH')}</td><td>${sale.id}</td><td>${itemDetails}</td><td>${discountAmount}</td><td><strong>${sale.total.toFixed(2)}</strong></td><td style="white-space: nowrap;">${actionCellHTML}</td>`;
            });
        },
        
        toggleUIVisibility() {
            const summarySection = document.getElementById('sales-summary-section');
            const filterSection = document.querySelector('.filter-section');

            if (this.state.isRestrictedMode) {
                if (summarySection) summarySection.style.display = 'none';
                if (filterSection) filterSection.style.display = 'none';
            } else {
                if (summarySection) summarySection.style.display = 'block';
                if (filterSection) filterSection.style.display = 'flex';
            }
            this.updateHistoryDisplay();
            this.updateCartDisplay();
        },

        filterHistoryByDateTime() {
            const startDateInput = document.getElementById('start-date').value;
            const startTimeInput = document.getElementById('start-time').value;
            const endDateInput = document.getElementById('end-date').value;
            const endTimeInput = document.getElementById('end-time').value;

            if (!startDateInput || !endDateInput) {
                this.showInfoModal("ข้อมูลไม่ครบถ้วน", "กรุณาเลือกทั้งวันที่เริ่มต้นและวันที่สิ้นสุด", false);
                return;
            }

            const startDateTime = new Date(`${startDateInput}T${startTimeInput || '00:00:00'}`);
            const endDateTime = new Date(`${endDateInput}T${endTimeInput || '23:59:59'}`);

            this.loadSalesHistoryFromFirestore(startDateTime.toISOString(), endDateTime.toISOString());
        },

        filterHistoryForToday() {
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);

            const todayEnd = new Date();
            todayEnd.setHours(23, 59, 59, 999);

            document.getElementById('start-date').value = todayStart.toISOString().split('T')[0];
            document.getElementById('start-time').value = '00:00';
            document.getElementById('end-date').value = todayEnd.toISOString().split('T')[0];
            document.getElementById('end-time').value = '23:59';

            this.loadSalesHistoryFromFirestore(todayStart.toISOString(), todayEnd.toISOString());
        },

        loadSalesHistoryFromFirestore(startDate, endDate) {
            const historyCollectionRef = this.getSalesHistoryCollectionRef();
            if (!historyCollectionRef) return;

            if (this.state.unsubscribeSalesHistory) {
                this.state.unsubscribeSalesHistory();
            }

            const { query, where } = window.firebaseServices.api;
            
            let q;
            document.getElementById('summary-title').textContent = `สรุปยอดขาย`;
            if (startDate && endDate) {
                 q = query(historyCollectionRef, 
                     where("timestamp", ">=", startDate), 
                     where("timestamp", "<=", endDate)
                 );
            } else {
                 q = query(historyCollectionRef);
            }

            this.state.unsubscribeSalesHistory = window.firebaseServices.api.onSnapshot(q, (querySnapshot) => {
                const newHistory = [];
                querySnapshot.forEach((doc) => {
                    newHistory.push({ ...doc.data(), firestoreId: doc.id });
                });
                this.state.salesHistory = newHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 
                this.updateHistoryDisplay();
                this.calculateSummaryForDisplayedHistory();
            }, (error) => {
                console.error("Error loading sales history:", error);
                if (error.code === 'permission-denied') {
                     this.showInfoModal("ข้อผิดพลาด Firestore", "การเชื่อมต่อ Firestore ล้มเหลว! (permission-denied)\n\nสาเหตุอาจเกิดจาก Security Rules ของคุณไม่อนุญาตให้อ่านข้อมูล\n\nวิธีแก้ไข:\n1. ไปที่ Firebase Console > Firestore Database > แท็บ 'Rules'\n2. ตรวจสอบว่าอนุญาตให้มีการอ่าน/เขียนข้อมูลหรือไม่ (สำหรับ test mode ควรเป็น: allow read, write: if true;)", true);
                }
            });
        },
        
        calculateSummaryForDisplayedHistory() {
            const displayedSales = this.state.salesHistory; 
            
            let totalSales = 0;
            let totalDiscount = 0;
            let netSales = 0;
            let totalCost = 0; 

            displayedSales.forEach(sale => {
                totalSales += sale.subtotal || 0;
                totalDiscount += sale.discount || 0;
                netSales += sale.total || 0;

                if (sale.items && Array.isArray(sale.items)) {
                    sale.items.forEach(item => {
                        const cost = item.cost || 0;
                        const quantity = item.quantity || 0;
                        totalCost += cost * quantity;
                    });
                }
            });

            const billCount = displayedSales.length;
            const profit = netSales - totalCost;

            const formatCurrency = (number) => {
                return number.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };

            document.getElementById('summary-total-sales').textContent = formatCurrency(totalSales);
            document.getElementById('summary-total-discount').textContent = formatCurrency(totalDiscount);
            document.getElementById('summary-net-sales').textContent = formatCurrency(netSales);
            document.getElementById('summary-bill-count').textContent = billCount.toLocaleString('en-US');
            document.getElementById('summary-profit').textContent = formatCurrency(profit);
        },
        
        async generateSaleId() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            const datePrefix = `${year}${month}${day}`;

            if (this.state.lastSaleDate !== datePrefix) {
                console.log("Counter reset or new day. Recalculating from local history...");
                
                const todaySales = this.state.salesHistory.filter(sale => sale.id && sale.id.startsWith(datePrefix));
                
                this.state.dailySaleCounter = todaySales.length;
                this.state.lastSaleDate = datePrefix;
                
                console.log(`Found ${todaySales.length} sales for today. Counter set to ${this.state.dailySaleCounter}.`);
            }
            
            this.state.dailySaleCounter++;
            const nextSequence = this.state.dailySaleCounter;
            
            return `${datePrefix}-${nextSequence.toString().padStart(4, '0')}`;
        },

        // --- EXPORT ---
        getHistoryForExport() {
            return this.state.salesHistory.flatMap(sale => 
                sale.items.map(item => ({
                    'รหัสการขาย': sale.id, 'วันที่': new Date(sale.timestamp).toLocaleDateString('th-TH'),
                    'เวลา': new Date(sale.timestamp).toLocaleTimeString('th-TH'), 
                    'ยอดรวมก่อนลด': sale.subtotal ? sale.subtotal.toFixed(2) : '0.00',
                    'ส่วนลด': sale.discount ? sale.discount.toFixed(2) : '0.00',
                    'ยอดสุทธิ': sale.total ? sale.total.toFixed(2) : '0.00',
                    'รหัสสินค้า': item.code,
                    'สินค้า': item.name, 
                    'หน่วย': item.unit, 
                    'จำนวน': item.quantity,
                    'ราคาต่อหน่วย': parseFloat(item.price), 
                    'ต้นทุน': parseFloat(item.cost || 0),
                    'ราคารวม (รายการนี้)': item.price * item.quantity
                }))
            );
        },

        exportToExcel() {
            const dataToExport = this.getHistoryForExport();
            if (dataToExport.length === 0) {
                this.showInfoModal("ไม่มีข้อมูล", "ไม่มีข้อมูลประวัติการขายให้ Export", false);
                return;
            }
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ประวัติการขาย');
            worksheet['!cols'] = [ {wch:20}, {wch:12}, {wch:12}, {wch:15},{wch:15},{wch:15}, {wch:15},{wch:30},{wch:10}, {wch:10},{wch:15},{wch:15},{wch:15} ];
            XLSX.writeFile(workbook, `pos-history-${new Date().toISOString().split('T')[0]}.xlsx`);
        },

        // --- TAB MANAGEMENT ---
        addNewSaleTab() {
            if (this.state.tabs.size >= 5) {
                this.showInfoModal("ไม่สามารถเปิดบิล", "ไม่สามารถเปิดบิลใหม่ได้เกิน 5 บิล", false);
                return;
            }
            
            let nextSaleNumber = 1;
            const usedNumbers = Array.from(this.state.tabs.values()).map(t => t.name ? parseInt(t.name.split(' ')[1]) : 0);
            while(usedNumbers.includes(nextSaleNumber)) {
                nextSaleNumber++;
            }

            const tabId = 'sale-' + Date.now();
            this.state.tabs.set(tabId, {
                cart: [],
                discount: 0,
                name: `บิล ${nextSaleNumber}`,
            });
            this.renderTabs();
            this.switchTab(tabId);
        },

        switchTab(tabId) {
            if (!this.state.tabs.has(tabId)) return;
            this.state.activeTabId = tabId;
            this.renderTabs();
            this.updateCartDisplay();
            document.getElementById('barcode-input').focus();
        },

        closeTab(tabId, confirm = true) {
            const tabData = this.state.tabs.get(tabId);
            if (!tabData) return;

            if (confirm && tabData.cart.length > 0) {
                this.showDeleteConfirmModal(tabId, true);
                return;
            }
            
            this.state.tabs.delete(tabId);
            
            if (this.state.activeTabId === tabId) {
                const remainingTabs = Array.from(this.state.tabs.keys());
                if (remainingTabs.length > 0) {
                    this.switchTab(remainingTabs[0]);
                } else {
                    this.addNewSaleTab();
                }
            }
            
            this.renderTabs();
        },

        renderTabs() {
            const tabsContainer = document.getElementById('cart-tabs');
            if (!tabsContainer) return;
            tabsContainer.innerHTML = '';
            
            const self = this;
            this.state.tabs.forEach((data, id) => {
                const tabButton = document.createElement('button');
                tabButton.className = 'tab-button';
                tabButton.textContent = data.name;
                tabButton.onclick = () => self.switchTab(id);

                if (id === this.state.activeTabId) {
                    tabButton.classList.add('active');
                }
                
                if (this.state.tabs.size > 1) {
                    const closeButton = document.createElement('button');
                    closeButton.className = 'close-tab-btn';
                    closeButton.innerHTML = '&times;';
                    closeButton.onclick = (e) => {
                        e.stopPropagation(); 
                        self.closeTab(id);
                    };
                    tabButton.appendChild(closeButton);
                }

                tabsContainer.appendChild(tabButton);
            });
        },

        navigateTabs(direction) {
            const tabKeys = Array.from(this.state.tabs.keys());
            if(tabKeys.length <= 1) return;

            let currentIndex = tabKeys.indexOf(this.state.activeTabId);
            currentIndex += direction;

            if (currentIndex >= tabKeys.length) {
                currentIndex = 0;
            } else if (currentIndex < 0) {
                currentIndex = tabKeys.length - 1;
            }
            
            this.switchTab(tabKeys[currentIndex]);
        }
    };

    // --- APPLICATION ENTRY POINT ---
    document.addEventListener('DOMContentLoaded', () => {
        window.POS_APP = POS_APP;
        POS_APP.init();
    });

</script>

</body>
</html>
